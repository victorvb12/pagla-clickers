<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pagla Clickers - Task Details</title>
<style>
  body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 0; }
  header, footer { background: #007bff; color: white; text-align: center; padding: 10px; }
  main { max-width: 900px; margin: 20px auto; padding: 10px; background: white; border-radius: 8px; box-shadow: 0 0 5px #ccc; }
  h1 { text-align: center; color: #007bff; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
  th { background-color: #007bff; color: white; }
  tr:nth-child(even) { background-color: #f2f2f2; }
  tr:hover { background-color: #e0f0ff; cursor: pointer; }
  .your-job-tag { background: #28a745; color: white; padding: 2px 5px; border-radius: 4px; font-size: 0.8em; }
  #jobModal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
  #jobModal .modal-content { background: white; border-radius: 8px; padding: 20px; max-width: 500px; width: 90%; position: relative; }
  #jobModal h2 { margin-top: 0; }
  #jobModal button.close { position: absolute; top: 10px; right: 10px; background: transparent; border: none; font-size: 1.5em; cursor: pointer; }
  textarea, input[type=file] { width: 100%; margin-top: 10px; }
  button.submit-proof { margin-top: 15px; padding: 10px 15px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
  button.submit-proof:disabled { background: #999; cursor: not-allowed; }
  #submissionStatus { margin-top: 10px; color: green; font-weight: bold; }
  #modalMessage { color: red; margin-top: 10px; }
</style>
</head>
<body>

<header>
  <h1>Pagla Clickers - Available Jobs</h1>
</header>

<main>
  <table id="jobsTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Title</th>
        <th>Category</th>
        <th>Reward</th>
        <th>Slots</th>
        <th>Submissions</th>
        <th>Owner</th>
      </tr>
    </thead>
    <tbody>
      <!-- Jobs will load here dynamically -->
    </tbody>
  </table>
</main>

<!-- Modal -->
<div id="jobModal">
  <div class="modal-content">
    <button class="close" title="Close">&times;</button>
    <h2 id="modalJobTitle"></h2>
    <p><strong>Category:</strong> <span id="modalJobCategory"></span></p>
    <p><strong>Reward:</strong> $<span id="modalJobReward"></span></p>
    <p><strong>Slots:</strong> <span id="modalJobSlots"></span></p>
    <p><strong>Submissions:</strong> <span id="modalJobSubmissions"></span></p>
    <p><strong>Owner:</strong> <span id="modalJobOwner"></span></p>

    <div id="submissionSection" style="margin-top:20px;">
      <!-- Submission form inputs will be dynamically inserted here -->
    </div>

    <p id="submissionStatus" style="display:none;">Submitted successfully!</p>
    <p id="modalMessage"></p>
  </div>
</div>

<script type="module">
// Import Firebase modules (adjust if using a bundler or CDN)
// NOTE: Replace the config object below with your Firebase project config.
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

// Your Firebase config here:
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;
let jobs = [];
let currentJobInModal = null;

const jobsTableBody = document.querySelector("#jobsTable tbody");
const jobModal = document.getElementById("jobModal");
const modalJobTitle = document.getElementById("modalJobTitle");
const modalJobCategory = document.getElementById("modalJobCategory");
const modalJobReward = document.getElementById("modalJobReward");
const modalJobSlots = document.getElementById("modalJobSlots");
const modalJobSubmissions = document.getElementById("modalJobSubmissions");
const modalJobOwner = document.getElementById("modalJobOwner");
const submissionSection = document.getElementById("submissionSection");
const submissionStatus = document.getElementById("submissionStatus");
const modalMessage = document.getElementById("modalMessage");

const closeModalBtn = jobModal.querySelector("button.close");
closeModalBtn.addEventListener("click", () => {
  jobModal.style.display = "none";
  submissionSection.innerHTML = "";
  modalMessage.textContent = "";
  submissionStatus.style.display = "none";
});

// Listen for auth state
onAuthStateChanged(auth, async user => {
  if (!user) {
    alert("You must be logged in to view jobs.");
    // Redirect or show login page, or handle anon access here.
    return;
  }
  currentUser = user;
  await loadJobs();
});

// Load jobs from Firestore
async function loadJobs() {
  const jobsSnapshot = await getDocs(collection(db, "jobs"));
  jobs = [];
  let index = 1;
  jobsTableBody.innerHTML = "";

  for (const jobDoc of jobsSnapshot.docs) {
    const jobData = jobDoc.data();
    jobData.id = jobDoc.id;

    // Check if current user already submitted for this job
    const submissionDoc = await getDoc(doc(db, "jobs", jobDoc.id, "submissions", currentUser.uid));
    jobData.hasSubmitted = submissionDoc.exists();

    // Mark if this job is owned by current user
    jobData.isOwnJob = (jobData.ownerId === currentUser.uid);

    jobs.push(jobData);

    // Build table row
    const tr = document.createElement("tr");

    // Serial number column
    const snTd = document.createElement("td");
    snTd.textContent = index++;
    tr.appendChild(snTd);

    // Title with click event to open modal
    const titleTd = document.createElement("td");
    titleTd.textContent = jobData.title;
    titleTd.style.cursor = "pointer";
    titleTd.style.color = "#007bff";
    titleTd.style.textDecoration = "underline";
    titleTd.addEventListener("click", () => openJobModal(jobData));
    tr.appendChild(titleTd);

    // Category
    const catTd = document.createElement("td");
    catTd.textContent = capitalize(jobData.category);
    tr.appendChild(catTd);

    // Reward
    const rewardTd = document.createElement("td");
    rewardTd.textContent = jobData.reward.toFixed(2);
    tr.appendChild(rewardTd);

    // Slots
    const slotsTd = document.createElement("td");
    slotsTd.textContent = jobData.totalSlots;
    tr.appendChild(slotsTd);

    // Submissions
    const submTd = document.createElement("td");
    submTd.textContent = jobData.submissions;
    tr.appendChild(submTd);

    // Owner with tag if current user
    const ownerTd = document.createElement("td");
    ownerTd.textContent = jobData.ownerName || "Unknown";
    if (jobData.isOwnJob) {
      const tag = document.createElement("span");
      tag.classList.add("your-job-tag");
      tag.textContent = "Your Job";
      ownerTd.appendChild(document.createTextNode(" "));
      ownerTd.appendChild(tag);
    }
    tr.appendChild(ownerTd);

    jobsTableBody.appendChild(tr);
  }
}

function capitalize(s) {
  if (!s) return "";
  return s.charAt(0).toUpperCase() + s.slice(1);
}

// Open modal and show job details & submission form
async function openJobModal(job) {
  currentJobInModal = job;

  modalJobTitle.textContent = job.title;
  modalJobCategory.textContent = capitalize(job.category);
  modalJobReward.textContent = job.reward.toFixed(2);
  modalJobSlots.textContent = job.totalSlots;
  modalJobSubmissions.textContent = job.submissions;
  modalJobOwner.textContent = job.ownerName || "Unknown";

  submissionStatus.style.display = 'none';
  modalMessage.textContent = "";
  submissionSection.innerHTML = "";

  // If job owner or already submitted or full slots reached, disable submission
  if (job.isOwnJob) {
    submissionSection.style.display = "none";
    modalMessage.textContent = "You cannot submit proof for your own job.";
    jobModal.style.display = "flex";
    return;
  }
  if (job.hasSubmitted) {
    submissionSection.style.display = "none";
    modalMessage.textContent = "You have already submitted proof for this job.";
    jobModal.style.display = "flex";
    return;
  }
  if (job.submissions >= job.totalSlots) {
    submissionSection.style.display = "none";
    modalMessage.textContent = "This job is already completed (slots full).";
    jobModal.style.display = "flex";
    return;
  }

  // Load job data fresh to get proofType (to be safe)
  const jobDocSnap = await getDoc(doc(db, "jobs", job.id));
  const jobData = jobDocSnap.exists() ? jobDocSnap.data() : null;

  const proofType = jobData?.proofType || "text"; // default fallback

  // Build submission form based on proofType
  let formHTML = `<h3>Submit Your Proof</h3>`;

  if (proofType === "text" || proofType === "both") {
    formHTML += `<textarea id="proofInput" rows="4" placeholder="Enter your proof here..."></textarea>`;
  }

  if (proofType === "screenshot" || proofType === "both") {
    formHTML += `<input type="file" id="screenshotInput" accept="image/*" style="margin-top:10px;">`;
  }

  formHTML += `<button id="submitProofBtn" class="submit-proof">Submit</button>`;

  submissionSection.innerHTML = formHTML;
  submissionSection.style.display = "block";

  // Attach event to submit button
  const submitBtn = document.getElementById("submitProofBtn");
  submitBtn.onclick = async () => {
    const proofInputEl = document.getElementById("proofInput");
    const screenshotInputEl = document.getElementById("screenshotInput");
    const textProof = proofInputEl ? proofInputEl.value.trim() : "";
    const screenshotFile = screenshotInputEl ? screenshotInputEl.files[0] : null;

    modalMessage.textContent = "";

    if ((proofType === "text" || proofType === "both") && !textProof) {
      modalMessage.textContent = "Please enter your proof text.";
      return;
    }
    if ((proofType === "screenshot" || proofType === "both") && !screenshotFile) {
      modalMessage.textContent = "Please upload a screenshot.";
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = "Submitting...";

    try {
      // For simplicity, we only store proof text and filename.
      // Uploading screenshot files to Storage can be added if you want.

      const proofData = {
        userId: currentUser.uid,
        userEmail: currentUser.email,
        timestamp: new Date(),
      };

      if (textProof) proofData.proofText = textProof;

      if (screenshotFile) {
        proofData.screenshotName = screenshotFile.name;
        // Upload to Firebase Storage can be implemented here
      }

      // Save submission under jobs/{jobId}/submissions/{userId}
      await setDoc(doc(db, "jobs", job.id, "submissions", currentUser.uid), proofData);

      // Update submission count locally and in UI
      job.submissions++;
      job.hasSubmitted = true;
      modalJobSubmissions.textContent = job.submissions;

      submissionStatus.style.display = "block";
      submissionStatus.textContent = "Submitted successfully!";
      submissionSection.style.display = "none";
      modalMessage.textContent = "";

      // Reload job list to update submission status (optional)
      await loadJobs();

    } catch (err) {
      modalMessage.textContent = "Error submitting proof: " + err.message;
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Submit";
    }
  };

  jobModal.style.display = "flex";
}

// Close modal on outside click
window.onclick = function(event) {
  if (event.target === jobModal) {
    jobModal.style.display = "none";
    submissionSection.innerHTML = "";
    modalMessage.textContent = "";
    submissionStatus.style.display = "none";
  }
};
</script>

</body>
</html>
