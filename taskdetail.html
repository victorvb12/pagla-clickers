<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Task Detail - Pagla Clickers</title>
  <style>
    /* Nav bar styling - matching your site's common style */
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px 0 40px 0;
      margin: 0;
    }
    nav {
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      font-weight: bold;
      font-size: 16px;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    nav a {
      color: white;
      text-decoration: none;
      padding: 6px 12px;
      border-radius: 4px;
      transition: background-color 0.3s ease;
    }
    nav a:hover {
      background-color: #0056b3;
    }

    /* Page content styling */
    h2 {
      margin-left: 20px;
    }

    .job {
      background: #fff;
      padding: 15px;
      margin: 15px 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .job-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    button {
      background: #28a745;
      color: white;
      border: none;
      padding: 7px 15px;
      border-radius: 3px;
      cursor: pointer;
    }
    button:disabled {
      background: #ccc;
    }
    #jobModal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    #jobModalContent {
      background: white;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      border-radius: 8px;
      position: relative;
    }
    .proof-input {
      width: 100%;
      margin-bottom: 10px;
    }
    .closeBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <nav>
    <a href="dashboard.html">Dashboard</a>
    <a href="taskdetail.html">Jobs</a>
    <a href="profile.html">Profile</a>
    <a href="referel.html">Refer & Earn</a>
    <a href="deposit.html">Deposit</a>
    <a href="wallet.html">Wallet</a>
    <a href="withdrawal.html">Withdraw</a>
    <a href="support.html">Support</a>
    <a href="faq.html">FAQ</a>
    <a href="terms.html">Terms</a>
    <a href="notifications.html">Notifications</a>
    <a href="#" onclick="logout()">Logout</a>
  </nav>

  <h2>Available Jobs</h2>
  <div id="jobsContainer">Loading...</div>

  <!-- Modal -->
  <div id="jobModal">
    <div id="jobModalContent">
      <button class="closeBtn" onclick="closeModal()">X</button>
      <h3 id="jobTitle"></h3>
      <div id="jobDetails"></div>
      <form id="proofForm"></form>
      <button id="submitBtn" style="display: none;">Submit Proof</button>
      <p id="submitStatus"></p>
    </div>
  </div>

  <!-- Firebase & Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAg-6k48R9c7ZK0xGe0BtNOa-5lF5JfmdI",
      authDomain: "pagla-b1c17.firebaseapp.com",
      projectId: "pagla-b1c17",
      storageBucket: "pagla-b1c17.appspot.com",
      messagingSenderId: "192578902502",
      appId: "1:192578902502:web:4b441210b15cfebf008ecf"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    const jobsContainer = document.getElementById("jobsContainer");
    const jobModal = document.getElementById("jobModal");
    const jobTitle = document.getElementById("jobTitle");
    const jobDetails = document.getElementById("jobDetails");
    const proofForm = document.getElementById("proofForm");
    const submitBtn = document.getElementById("submitBtn");
    const submitStatus = document.getElementById("submitStatus");

    let currentUser = null;
    let currentJob = null;
    let jobList = [];

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        await loadJobs();
      } else {
        jobsContainer.innerHTML = "<p>Please log in to view jobs.</p>";
      }
    });

    async function loadJobs() {
      const jobSnap = await getDocs(collection(db, "jobs"));
      jobList = [];

      await Promise.all(jobSnap.docs.map(async (docSnap) => {
        const data = docSnap.data();
        const jobId = docSnap.id;

        const subsSnap = await getDocs(collection(db, `jobs/${jobId}/submissions`));
        const submittedCount = subsSnap.size;

        jobList.push({ id: jobId, ...data, submitted: submittedCount });
      }));

      renderJobs();
    }

    function renderJobs() {
      jobsContainer.innerHTML = "";
      jobList.forEach(job => {
        const submitted = job.submitted || 0;
        const slots = job.slots || "∞";
        const slotInfo = slots === "∞" ? "Unlimited slots" : `${submitted} / ${slots} slots used`;

        const isOwner = job.ownerId === currentUser?.uid;
        const crown = isOwner ? " 👑 Your Job" : "";

        const div = document.createElement("div");
        div.className = "job";
        div.innerHTML = `
          <div class="job-title">${job.title}${crown}</div>
          <p>Reward: $${job.reward}</p>
          <p>Category: ${job.category}</p>
          <p>Slots: ${slotInfo}</p>
          <button class="viewBtn" onclick="openModal('${job.id}')">View & Submit</button>
        `;
        jobsContainer.appendChild(div);
      });
    }

    window.openModal = async (jobId) => {
      currentJob = jobList.find(j => j.id === jobId);
      if (!currentJob) return;

      if (currentJob.ownerId === currentUser.uid) {
        jobTitle.textContent = "Your Own Job";
        jobDetails.innerHTML = `
          <p><strong>Description:</strong> ${currentJob.description || "No description available."}</p>
          <p>You cannot submit to your own job.</p>
        `;
        proofForm.innerHTML = "";
        submitBtn.style.display = "none";
        submitStatus.textContent = "";
        jobModal.style.display = "flex";
        return;
      }

      const submissionDoc = await getDoc(doc(db, `jobs/${jobId}/submissions/${currentUser.uid}`));
      if (submissionDoc.exists()) {
        jobTitle.textContent = "Already Submitted";
        jobDetails.innerHTML = `
          <p><strong>Description:</strong> ${currentJob.description || "No description available."}</p>
          <p>You have already submitted proof for this job.</p>
        `;
        proofForm.innerHTML = "";
        submitBtn.style.display = "none";
      } else {
        jobTitle.textContent = currentJob.title;
        jobDetails.innerHTML = `<p><strong>Description:</strong> ${currentJob.description || "No description available."}</p><p>Submit the following proofs:</p>`;

        proofForm.innerHTML = "";
        const proofs = (currentJob.proofType || "").split(',').map(p => p.trim()).filter(Boolean);
        proofs.forEach((type, index) => {
          const label = document.createElement("label");
          label.textContent = `Proof ${index + 1} (${type})`;
          const input = document.createElement("input");

          if (type === "text") {
            input.type = "text";
          } else if (type === "screenshot") {
            input.type = "file";
            input.accept = "image/*";
          }

          input.name = `proof${index + 1}`;
          input.required = true;
          input.className = "proof-input";

          proofForm.appendChild(label);
          proofForm.appendChild(input);
        });

        submitBtn.style.display = "block";
      }

      submitStatus.textContent = "";
      jobModal.style.display = "flex";
    };

    submitBtn.onclick = async (e) => {
      e.preventDefault();

      const inputs = proofForm.querySelectorAll("input");
      const proofData = {};
      submitStatus.style.color = "black";
      submitStatus.textContent = "Uploading proofs... Please wait.";

      async function uploadFile(file, proofName) {
        return new Promise((resolve, reject) => {
          const fileName = `${currentUser.uid}_${currentJob.id}_${proofName}_${Date.now()}`;
          const storageReference = storageRef(storage, `submissions/${fileName}`);
          const uploadTask = uploadBytesResumable(storageReference, file);

          uploadTask.on('state_changed',
            () => {},
            (error) => reject(error),
            () => {
              getDownloadURL(uploadTask.snapshot.ref).then(url => resolve(url));
            }
          );
        });
      }

      try {
        for (const input of inputs) {
          if (input.type === "text") {
            if (!input.value.trim()) {
              submitStatus.style.color = "red";
              submitStatus.textContent = "Please fill all text fields.";
              return;
            }
            proofData[input.name] = input.value.trim();
          } else if (input.type === "file") {
            if (!input.files[0]) {
              submitStatus.style.color = "red";
              submitStatus.textContent = "Please select all screenshots.";
              return;
            }
            const url = await uploadFile(input.files[0], input.name);
            proofData[input.name] = url;
          }
        }

        await setDoc(doc(db, `jobs/${currentJob.id}/submissions/${currentUser.uid}`), {
          userId: currentUser.uid,
          userEmail: currentUser.email,
          timestamp: new Date(),
          proofs: proofData
        });

        submitStatus.style.color = "green";
        submitStatus.textContent = "✅ Submission successful!";
        submitBtn.style.display = "none";
        currentJob.submitted = (currentJob.submitted || 0) + 1;
        renderJobs();
      } catch (err) {
        submitStatus.style.color = "red";
        submitStatus.textContent = "❌ Submission failed: " + err.message;
      }
    };

    window.closeModal = () => {
      jobModal.style.display = "none";
      currentJob = null;
      proofForm.innerHTML = "";
      submitStatus.textContent = "";
    };

    window.logout = () => {
      signOut(auth).then(() => {
        window.location.href = "login.html";
      });
    };
  </script>
</body>
</html>
