<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Task Details - Pagla Clickers</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #eef;
      padding: 20px;
    }
    .job {
      background: white;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
    }
    .job-title {
      font-size: 18px;
      font-weight: bold;
    }
    .viewBtn {
      background: #007bff;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 99;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
    }
    .proof-input {
      margin-bottom: 10px;
    }
    input[type="file"], input[type="text"] {
      width: 100%;
      padding: 8px;
    }
    button {
      padding: 10px;
      margin-top: 10px;
      background: green;
      color: white;
      border: none;
      border-radius: 4px;
    }
    .status { margin-top: 10px; color: darkgreen; }
  </style>
</head>
<body>

<h2>Available Jobs</h2>
<div id="jobsContainer"></div>

<!-- Modal -->
<div class="modal" id="jobModal">
  <div class="modal-content">
    <h3 id="jobTitle"></h3>
    <p id="jobDetails"></p>
    <form id="proofForm"></form>
    <button id="submitBtn">Submit Proof</button>
    <div class="status" id="submitStatus"></div>
    <button onclick="closeModal()">Close</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAg-6k48R9c7ZK0xGe0BtNOa-5lF5JfmdI",
    authDomain: "pagla-b1c17.firebaseapp.com",
    projectId: "pagla-b1c17",
    storageBucket: "pagla-b1c17.appspot.com",
    messagingSenderId: "192578902502",
    appId: "1:192578902502:web:4b441210b15cfebf008ecf"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const jobsContainer = document.getElementById("jobsContainer");
  const jobModal = document.getElementById("jobModal");
  const jobTitle = document.getElementById("jobTitle");
  const jobDetails = document.getElementById("jobDetails");
  const proofForm = document.getElementById("proofForm");
  const submitBtn = document.getElementById("submitBtn");
  const submitStatus = document.getElementById("submitStatus");

  let currentUser = null;
  let currentJob = null;
  let jobList = [];

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      await loadJobs();
    } else {
      jobsContainer.innerHTML = "<p>Please log in to view jobs.</p>";
    }
  });

  async function loadJobs() {
    const jobSnap = await getDocs(collection(db, "jobs"));
    jobSnap.forEach(docSnap => {
      const data = docSnap.data();
      jobList.push({ id: docSnap.id, ...data });
    });
    renderJobs();
  }

  function renderJobs() {
    jobsContainer.innerHTML = "";
    jobList.forEach(job => {
      const div = document.createElement("div");
      div.className = "job";
      div.innerHTML = `
        <div class="job-title">${job.title}</div>
        <p>Reward: $${job.reward}</p>
        <p>Category: ${job.category}</p>
        <button class="viewBtn" onclick="openModal('${job.id}')">View & Submit</button>
      `;
      jobsContainer.appendChild(div);
    });
  }

  window.openModal = async (jobId) => {
    currentJob = jobList.find(j => j.id === jobId);
    if (!currentJob) return;

    const alreadySubmitted = await getDoc(doc(db, `jobs/${jobId}/submissions/${currentUser.uid}`));
    if (alreadySubmitted.exists()) {
      jobTitle.textContent = "Already Submitted";
      jobDetails.textContent = "You have already submitted proof for this job.";
      proofForm.innerHTML = "";
      submitBtn.style.display = "none";
    } else {
      jobTitle.textContent = currentJob.title;
      jobDetails.textContent = `Submit the following proofs:`;

      proofForm.innerHTML = "";
      const proofs = (currentJob.proofType || "").split(',').map(p => p.trim()).filter(Boolean);
      proofs.forEach((type, index) => {
        const label = document.createElement("label");
        label.textContent = `Proof ${index + 1} (${type})`;

        let input;
        if (type === "text") {
          input = document.createElement("input");
          input.type = "text";
          input.required = true;
        } else if (type === "screenshot") {
          input = document.createElement("input");
          input.type = "file";
          input.accept = "image/*";
          input.required = true;
        }

        input.name = `proof${index + 1}`;
        input.className = "proof-input";

        proofForm.appendChild(label);
        proofForm.appendChild(input);
      });

      submitBtn.style.display = "block";
    }

    submitStatus.textContent = "";
    jobModal.style.display = "flex";
  };

  submitBtn.onclick = async () => {
    const data = {};
    const inputs = proofForm.querySelectorAll("input");

    for (const input of inputs) {
      if (input.type === "text") {
        if (!input.value.trim()) {
          submitStatus.textContent = "Please fill all text fields.";
          return;
        }
        data[input.name] = input.value.trim();
      } else if (input.type === "file") {
        if (!input.files[0]) {
          submitStatus.textContent = "Please select all screenshots.";
          return;
        }
        data[input.name] = "screenshot_uploaded_placeholder"; // actual upload needed
      }
    }

    try {
      await setDoc(doc(db, `jobs/${currentJob.id}/submissions/${currentUser.uid}`), {
        userId: currentUser.uid,
        userEmail: currentUser.email,
        timestamp: new Date(),
        proofs: data
      });

      submitStatus.textContent = "✅ Submission successful!";
      submitBtn.style.display = "none";
    } catch (err) {
      submitStatus.textContent = "❌ Submission failed: " + err.message;
    }
  };

  window.closeModal = () => {
    jobModal.style.display = "none";
    currentJob = null;
  };
</script>

</body>
</html>
