<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tasks - Pagla Clickers</title>
  <style>
    /* Your common site styles, simplified example */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
      margin: 0; padding: 0;
    }
    header {
      background-color: #007bff;
      color: white;
      padding: 12px;
      text-align: center;
    }
    nav {
      background-color: #0056b3;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      padding: 10px;
    }
    nav a {
      color: white;
      text-decoration: none;
      padding: 8px 14px;
      border-radius: 5px;
      background-color: #0069d9;
    }
    nav a:hover {
      background-color: #004a99;
    }

    h2 {
      text-align: center;
      margin-top: 20px;
      color: #333;
    }
    #jobsContainer {
      max-width: 700px;
      margin: 20px auto;
      padding: 0 10px;
    }
    .job {
      background: white;
      border-left: 5px solid #007bff;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgb(0 0 0 / 0.1);
      position: relative;
    }
    .job-title {
      font-weight: 700;
      font-size: 1.2rem;
      color: #007bff;
      margin-bottom: 4px;
      display: inline-block;
    }
    .crown-tag {
      font-size: 18px;
      color: gold;
      margin-left: 8px;
      vertical-align: middle;
    }
    .job-details {
      margin: 6px 0;
      color: #555;
    }
    .slots-info {
      font-weight: 600;
      color: #333;
    }
    .viewBtn {
      background-color: #28a745;
      border: none;
      color: white;
      padding: 8px 15px;
      cursor: pointer;
      border-radius: 5px;
      margin-top: 10px;
      font-size: 1rem;
    }
    .viewBtn:disabled {
      background-color: #888;
      cursor: not-allowed;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: white;
      padding: 20px 25px;
      border-radius: 8px;
      max-width: 480px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .modal-content h3 {
      margin-top: 0;
      color: #007bff;
    }
    .closeBtn {
      position: absolute;
      right: 15px;
      top: 15px;
      background: transparent;
      border: none;
      font-size: 22px;
      cursor: pointer;
      color: #999;
    }
    .closeBtn:hover {
      color: #333;
    }

    form label {
      display: block;
      margin-top: 12px;
      font-weight: 600;
      color: #333;
    }
    form input[type="text"],
    form input[type="file"] {
      width: 100%;
      margin-top: 6px;
      padding: 7px 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    #submitBtn {
      margin-top: 15px;
      background-color: #007bff;
      border: none;
      color: white;
      padding: 10px 18px;
      font-size: 1rem;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
    }
    #submitBtn:disabled {
      background-color: #888;
      cursor: not-allowed;
    }

    #submitStatus {
      margin-top: 12px;
      font-weight: 700;
      min-height: 24px;
    }
  </style>
</head>
<body>

<header>
  <h1>Pagla Clickers</h1>
  <nav>
    <a href="about.html">About</a>
    <a href="notifications.html">Notifications</a>
    <a href="profile.html">Profile</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="postjob.html">Post Job</a>
    <a href="taskdetail.html" style="background:#004a99;">Tasks</a>
    <a href="referel.html">Referral</a>
    <a href="deposit.html">Deposit</a>
    <a href="wallet.html">Wallet</a>
    <a href="withdrawal.html">Withdraw Money</a>
    <a href="terms.html">Terms</a>
    <a href="faq.html">FAQ</a>
    <a href="support.html">Support</a>
  </nav>
</header>

<h2>Available Jobs</h2>
<div id="jobsContainer">
  <!-- jobs will load here -->
</div>

<!-- Modal -->
<div class="modal" id="jobModal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="jobTitle">
    <button class="closeBtn" aria-label="Close" onclick="closeModal()">&times;</button>
    <h3 id="jobTitle"></h3>
    <p id="jobDescription" style="color:#444;"></p>
    <form id="proofForm"></form>
    <button id="submitBtn">Submit Proof</button>
    <div id="submitStatus"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
  import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAg-6k48R9c7ZK0xGe0BtNOa-5lF5JfmdI",
    authDomain: "pagla-b1c17.firebaseapp.com",
    projectId: "pagla-b1c17",
    storageBucket: "pagla-b1c17.appspot.com",
    messagingSenderId: "192578902502",
    appId: "1:192578902502:web:4b441210b15cfebf008ecf"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

  const jobsContainer = document.getElementById("jobsContainer");
  const jobModal = document.getElementById("jobModal");
  const jobTitle = document.getElementById("jobTitle");
  const jobDescription = document.getElementById("jobDescription");
  const proofForm = document.getElementById("proofForm");
  const submitBtn = document.getElementById("submitBtn");
  const submitStatus = document.getElementById("submitStatus");

  let currentUser = null;
  let currentJob = null;
  let jobList = [];

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      await loadJobs();
    } else {
      jobsContainer.innerHTML = "<p style='text-align:center;color:#666;'>Please log in to view jobs.</p>";
    }
  });

  async function loadJobs() {
    jobsContainer.innerHTML = "<p style='text-align:center;'>Loading jobs...</p>";
    const jobsSnapshot = await getDocs(collection(db, "jobs"));
    jobList = [];

    // Load job data and count submissions
    await Promise.all(jobsSnapshot.docs.map(async (docSnap) => {
      const data = docSnap.data();
      const jobId = docSnap.id;

      // Count submissions
      const submissionsSnapshot = await getDocs(collection(db, `jobs/${jobId}/submissions`));
      const submittedCount = submissionsSnapshot.size;

      jobList.push({
        id: jobId,
        ...data,
        submittedCount: submittedCount
      });
    }));

    renderJobs();
  }

  function renderJobs() {
    jobsContainer.innerHTML = "";

    if (jobList.length === 0) {
      jobsContainer.innerHTML = "<p style='text-align:center;color:#666;'>No jobs available right now.</p>";
      return;
    }

    jobList.forEach(job => {
      const submitted = job.submittedCount || 0;
      const slots = job.slots || 100; // default 100 if missing
      const slotText = `${submitted} / ${slots}`;

      // Check if current user is the owner of the job
      const isOwner = currentUser && job.userId === currentUser.uid;

      // Disable view button if slots full or own job (cannot submit own job)
      const slotsFull = submitted >= slots;

      const jobDiv = document.createElement("div");
      jobDiv.className = "job";

      jobDiv.innerHTML = `
        <div>
          <span class="job-title">${escapeHtml(job.title)}</span>
          ${isOwner ? '<span class="crown-tag" title="Your Job">👑</span>' : ''}
        </div>
        <div class="job-details"><strong>Reward:</strong> $${escapeHtml(job.reward)}</div>
        <div class="job-details"><strong>Category:</strong> ${escapeHtml(job.category)}</div>
        <div class="job-details slots-info"><strong>Slots:</strong> ${slotText}</div>
        <button class="viewBtn" ${ (slotsFull || isOwner) ? 'disabled' : '' } onclick="openModal('${job.id}')">
          ${ isOwner ? "Your Job" : (slotsFull ? "Slots Full" : "View & Submit") }
        </button>
      `;

      jobsContainer.appendChild(jobDiv);
    });
  }

  window.openModal = async function(jobId) {
    currentJob = jobList.find(j => j.id === jobId);
    if (!currentJob) return;

    // Check if already submitted
    const submissionDoc = await getDoc(doc(db, `jobs/${jobId}/submissions/${currentUser.uid}`));
    if (submissionDoc.exists()) {
      jobTitle.textContent = currentJob.title + " (Already Submitted)";
      jobDescription.textContent = "You have already submitted proof for this job.";
      proofForm.innerHTML = "";
      submitBtn.style.display = "none";
      submitStatus.textContent = "";
      jobModal.classList.add("active");
      return;
    }

    jobTitle.textContent = currentJob.title;
    jobDescription.textContent = currentJob.description || "No description available.";

    proofForm.innerHTML = "";

    const proofs = (currentJob.proofType || "").split(",").map(p => p.trim().toLowerCase()).filter(Boolean);

    proofs.forEach((type, index) => {
      const label = document.createElement("label");
      label.textContent = `Proof ${index + 1} (${type})`;
      const input = document.createElement("input");

      if (type === "text") {
        input.type = "text";
        input.placeholder = "Enter text proof here";
      } else if (type === "screenshot") {
        input.type = "file";
        input.accept = "image/*";
      } else {
        input.type = "text"; // fallback
      }

      input.name = `proof${index + 1}`;
      input.required = true;
      proofForm.appendChild(label);
      proofForm.appendChild(input);
    });

    submitBtn.style.display = "block";
    submitStatus.textContent = "";
    jobModal.classList.add("active");
  };

  submitBtn.onclick = async function(e) {
    e.preventDefault();

    if (!currentJob) return;

    const inputs = proofForm.querySelectorAll("input");
    const proofData = {};

    submitStatus.style.color = "black";
    submitStatus.textContent = "Uploading proofs... Please wait.";

    async function uploadFile(file, proofName) {
      return new Promise((resolve, reject) => {
        const fileName = `${currentUser.uid}_${currentJob.id}_${proofName}_${Date.now()}`;
        const storageReference = storageRef(storage, `submissions/${fileName}`);
        const uploadTask = uploadBytesResumable(storageReference, file);

        uploadTask.on('state_changed',
          () => {},
          (error) => reject(error),
          () => {
            getDownloadURL(uploadTask.snapshot.ref).then(url => resolve(url));
          }
        );
      });
    }

    try {
      for (const input of inputs) {
        if (input.type === "text") {
          if (!input.value.trim()) {
            submitStatus.style.color = "red";
            submitStatus.textContent = "Please fill all text proof fields.";
            return;
          }
          proofData[input.name] = input.value.trim();
        } else if (input.type === "file") {
          if (!input.files[0]) {
            submitStatus.style.color = "red";
            submitStatus.textContent = "Please select all screenshot proofs.";
            return;
          }
          const url = await uploadFile(input.files[0], input.name);
          proofData[input.name] = url;
        }
      }

      await setDoc(doc(db, `jobs/${currentJob.id}/submissions/${currentUser.uid}`), {
        userId: currentUser.uid,
        userEmail: currentUser.email,
        timestamp: new Date(),
        proofs: proofData
      });

      submitStatus.style.color = "green";
      submitStatus.textContent = "✅ Submission successful!";
      submitBtn.style.display = "none";

      // Update submitted count locally and rerender
      currentJob.submittedCount = (currentJob.submittedCount || 0) + 1;
      renderJobs();
    } catch (err) {
      submitStatus.style.color = "red";
      submitStatus.textContent = "❌ Submission failed: " + err.message;
    }
  };

  window.closeModal = function() {
    jobModal.classList.remove("active");
    proofForm.innerHTML = "";
    submitStatus.textContent = "";
    currentJob = null;
  };

  // Helper to escape html special chars in job text to prevent XSS
  function escapeHtml(text) {
    if (!text) return "";
    return text.replace(/[&<>"']/g, (m) => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    })[m]);
  }
</script>

</body>
</html>
