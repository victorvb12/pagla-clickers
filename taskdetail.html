<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>All Tasks - Pagla Clickers</title>
  <style>
    /* ← Your existing CSS, unchanged… */
    body { font-family: Arial, sans-serif; background: #f4f8fc; margin: 0; padding: 0; }
    header, footer { background: #007bff; color: white; text-align: center; padding: 15px; }
    nav { background: #0056b3; display: flex; justify-content: center; gap: 20px; padding: 10px; flex-wrap: wrap; }
    nav a { color: white; text-decoration: none; font-weight: bold; }
    nav a:hover { text-decoration: underline; }
    .container { max-width: 900px; margin: 30px auto; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .filters { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
    .filters > * { flex: 1 1 200px; }
    input[type="search"], select { width: 100%; padding: 8px 12px; font-size: 16px; border: 1px solid #ccc; border-radius: 6px; }
    .job { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; padding: 15px 0; }
    .job:last-child { border-bottom: none; }
    .job-left { flex: 1; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
    .reward { font-weight: bold; background-color: #007bff; color: white; padding: 6px 12px; border-radius: 5px; font-size: 14px; min-width: 70px; text-align: center; white-space: nowrap; }
    .job-title { font-weight: bold; font-size: 16px; color: #007bff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 450px; }
    .badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-left: 10px; white-space: nowrap; user-select: none; }
    .badge-own { background-color: #ffc107; color: #000; }
    .badge-completed { background-color: #28a745; color: white; }
    .badge-available { background-color: #dc3545; color: white; }
    .job-right { text-align: right; min-width: 180px; display: flex; flex-direction: column; align-items: flex-end; gap: 5px; white-space: nowrap; }
    .job-right a { color: #0056b3; text-decoration: none; font-weight: bold; cursor: pointer; }
    .job-right a:hover { text-decoration: underline; }
    .job-stats { font-size: 13px; color: #666; }

    /* — Modal — */
    .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px 30px; border-radius: 10px; width: 90%; max-width: 500px; position: relative; box-shadow: 0 0 15px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }
    .close { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; color: #555; user-select: none; }
    .close:hover { color: #000; }
    #proofContainer > div { margin-bottom: 12px; }
    #proofContainer label { font-weight: bold; display: block; margin-bottom: 4px; }
    #proofContainer textarea, #proofContainer input[type="file"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
    #submitProofBtn { margin-top: 10px; padding: 10px 18px; background-color: #007bff; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
    #submitProofBtn:disabled { background-color: #999; cursor: not-allowed; }
    #submissionStatus { color: green; margin-top: 10px; display: none; }
    #modalMessage { color: red; margin-top: 10px; }
  </style>
</head>
<body>

<header>
  <h1>Pagla Clickers - Available Tasks</h1>
  <nav>
    <a href="about.html">About</a>
    <a href="notifications.html">Notifications</a>
    <a href="profile.html">Profile</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="postjob.html">Post Job</a>
    <a href="taskdetail.html">Tasks</a>
    <a href="referel.html">Referral</a>
    <a href="deposit.html">Deposit</a>
    <a href="wallet.html">Wallet</a>
    <a href="withdrawal.html">Withdraw Money</a>
    <a href="terms.html">Terms</a>
    <a href="faq.html">FAQ</a>
    <a href="support.html">Support</a>
  </nav>
</header>

<div class="container">
  <div class="filters">
    <input type="search" id="searchInput" placeholder="Search tasks by title..." />
    <select id="categoryFilter">
      <option value="">All Categories</option>
      <option value="youtube">YouTube</option>
      <option value="telegram">Telegram</option>
      <option value="facebook">Facebook</option>
    </select>
    <select id="sortFilter">
      <option value="rewardDesc">Sort by Reward: High to Low</option>
      <option value="rewardAsc">Sort by Reward: Low to High</option>
    </select>
  </div>
  <div id="jobsContainer">
    <h2>Loading tasks...</h2>
  </div>
</div>

<!-- Modal -->
<div id="jobModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span id="closeModal" class="close">&times;</span>
    <h2 id="modalJobTitle"></h2>
    <p id="modalJobDesc"></p>
    <p><strong>Reward:</strong> $<span id="modalJobReward"></span></p>
    <p><strong>Slots:</strong> <span id="modalJobSlots"></span></p>
    <p><strong>Submissions:</strong> <span id="modalJobSubmissions"></span></p>

    <div id="proofContainer"></div>
    <button id="submitProofBtn">Submit Proof</button>
    <p id="submissionStatus">Submitted successfully!</p>
    <p id="modalMessage"></p>
  </div>
</div>

<footer><p>&copy; 2025 Pagla Clickers</p></footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

  const firebaseConfig = { /* your config */ };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let currentUser, allJobs = [], currentJob = null;
  const jobsContainer = document.getElementById('jobsContainer');
  const searchInput = document.getElementById('searchInput');
  const categoryFilter = document.getElementById('categoryFilter');
  const sortFilter = document.getElementById('sortFilter');

  const jobModal = document.getElementById('jobModal');
  const closeModalBtn = document.getElementById('closeModal');
  const modalTitle = document.getElementById('modalJobTitle');
  const modalDesc = document.getElementById('modalJobDesc');
  const modalReward = document.getElementById('modalJobReward');
  const modalSlots = document.getElementById('modalJobSlots');
  const modalSubs = document.getElementById('modalJobSubmissions');
  const proofContainer = document.getElementById('proofContainer');
  const submitBtn = document.getElementById('submitProofBtn');
  const statusMsg = document.getElementById('submissionStatus');
  const modalMsg = document.getElementById('modalMessage');

  onAuthStateChanged(auth, async user => {
    if (!user) {
      jobsContainer.innerHTML = "<p>Please login to view tasks.</p>";
      return;
    }
    currentUser = user;
    await loadJobs();
    applyFilters();
  });

  async function loadJobs() {
    const snap = await getDocs(collection(db, "jobs"));
    allJobs = [];
    for (const d of snap.docs) {
      const j = d.data();
      j.id = d.id;
      // check if submitted
      const sub = await getDoc(doc(db, "jobs", j.id, "submissions", currentUser.uid));
      j.submitted = sub.exists();
      j.own = j.ownerId === currentUser.uid;
      allJobs.push(j);
    }
  }

  function renderJobs(list) {
    jobsContainer.innerHTML = "";
    if (!list.length) { jobsContainer.innerHTML = "<p>No tasks match.</p>"; return; }
    list.forEach((j,i) => {
      const div = document.createElement('div'); div.className='job';
      const badge = j.own?'<span class="badge badge-own">👑 Your Job</span>' 
                  : j.submitted?'<span class="badge badge-completed">✅ Completed</span>'
                  : '<span class="badge badge-available">🔥 Available</span>';
      div.innerHTML = `
        <div class="job-left">
          <div class="reward">$${j.reward.toFixed(2)}</div>
          <div><div class="job-title">${i+1}. ${j.title} ${badge}</div></div>
        </div>
        <div class="job-right">
          <a href="#" data-idx="${i}" class="viewDetailsLink">View Details</a>
          <div class="job-stats">${j.submissions}/${j.slots} Done</div>
        </div>`;
      jobsContainer.appendChild(div);
    });
    document.querySelectorAll('.viewDetailsLink').forEach(a=>{
      a.onclick=e=>{
        e.preventDefault();
        openModal(allJobs[+a.dataset.idx]);
      };
    });
  }

  function applyFilters(){
    let f = allJobs.slice();
    const cat = categoryFilter.value;
    if(cat) f = f.filter(j=>j.category.toLowerCase()===cat);
    const term = searchInput.value.toLowerCase();
    if(term) f = f.filter(j=>j.title.toLowerCase().includes(term));
    f.sort((a,b)=> sortFilter.value==='rewardAsc'? a.reward-b.reward: b.reward-a.reward);
    renderJobs(f);
  }
  searchInput.oninput=categoryFilter.onchange=sortFilter.onchange=applyFilters;

  function openModal(job){
    currentJob=job;
    modalTitle.textContent=job.title;
    modalDesc.textContent=job.description;
    modalReward.textContent=job.reward.toFixed(2);
    modalSlots.textContent=job.slots;
    modalSubs.textContent=job.submissions;
    statusMsg.style.display='none'; modalMsg.textContent='';
    proofContainer.innerHTML='';

    // build proof inputs
    job.proofs.forEach((p,idx)=>{
      if(p==='text'||p==='both')
        proofContainer.innerHTML+=`
          <div>
            <label>Text Proof ${idx+1}:</label>
            <textarea id="proofText${idx}" rows="3"></textarea>
          </div>`;
      if(p==='screenshot'||p==='both')
        proofContainer.innerHTML+=`
          <div>
            <label>Screenshot ${idx+1}:</label>
            <input type="file" id="proofImg${idx}" accept="image/*"/>
          </div>`;
    });

    submitBtn.disabled=false; submitBtn.textContent='Submit';
    jobModal.style.display='flex';
  }

  closeModalBtn.onclick=()=>jobModal.style.display='none';

  submitBtn.onclick=async()=>{
    const data={ userId:currentUser.uid, timestamp:new Date() };
    let allEmpty=true;
    currentJob.proofs.forEach((p,idx)=>{
      if(p==='text'||p==='both'){
        const t=document.getElementById(`proofText${idx}`).value.trim();
        if(t){ data[`text${idx}`]=t; allEmpty=false; }
      }
      if(p==='screenshot'||p==='both'){
        const f=document.getElementById(`proofImg${idx}`).files[0];
        if(f){ data[`img${idx}`]=f.name; allEmpty=false; }
      }
    });
    if(allEmpty){ modalMsg.textContent='Please fill at least one proof.'; return; }
    submitBtn.disabled=true; submitBtn.textContent='Submitting...';
    await setDoc(doc(db, "jobs", currentJob.id, "submissions", currentUser.uid), data);
    statusMsg.style.display='block'; statusMsg.textContent='Submitted!';
    jobModal.style.display='none';
    currentJob.submitted=true; currentJob.submissions++;
    applyFilters();
  };
</script>

</body>
</html>
