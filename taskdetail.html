<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Task Detail - Pagla Clickers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f8fc;
      user-select: none;
      padding-bottom: 40px;
    }

    /* Topbar */
    header {
      background: #007bff;
      color: white;
      text-align: center;
      padding: 25px 0;
      font-size: 26px;
      font-weight: bold;
      position: relative;
    }

    /* Navbar */
    nav {
      background: #005bb5;
      position: relative;
      z-index: 1000;
    }

    nav ul {
      margin: 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
    }

    nav ul li {
      margin: 10px 15px;
    }

    nav ul li a {
      color: white;
      text-decoration: none;
      font-weight: bold;
      font-size: 16px;
      white-space: nowrap;
    }

    nav ul li a:hover,
    nav ul li a[aria-current="page"] {
      text-decoration: underline;
    }

    nav ul li button#logoutBtn {
      background: #dc3545;
      color: white;
      padding: 6px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      line-height: normal;
      height: 36px;
      transition: background-color 0.3s ease;
      white-space: nowrap;
    }

    nav ul li button#logoutBtn:hover {
      background: #b02a37;
    }

    /* Blue strip below navbar */
    .blue-strip-below-nav {
      background-color: #007bff;
      height: 10px;
      width: 100%;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    /* Hamburger */
    .hamburger {
      display: none;
      font-size: 24px;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      position: absolute;
      top: 50%;
      right: 15px;
      transform: translateY(-50%);
      z-index: 1100;
    }

    /* Job heading */
    h2 {
      margin-left: 20px;
      color: #007bff;
    }

    /* Job card */
    .job {
      background: white;
      padding: 15px 20px;
      margin: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      user-select: text;
    }

    .job-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 8px;
    }

    p {
      margin: 5px 0;
      user-select: text;
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      transition: background-color 0.3s ease;
    }

    button:hover:not(:disabled) {
      background: #005bb5;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* Modal */
    #jobModal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    #jobModalContent {
      background: white;
      padding: 25px;
      width: 90%;
      max-width: 520px;
      border-radius: 12px;
      position: relative;
      box-sizing: border-box;
    }

    label {
      display: block;
      margin: 10px 0 4px 0;
      font-weight: 600;
    }

    .proof-input {
      width: 100%;
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .closeBtn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    .closeBtn:hover {
      background: #b02a37;
    }

    #submitStatus {
      margin-top: 10px;
      font-weight: 600;
      min-height: 1.5em;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      nav ul {
        display: none;
        flex-direction: column;
        width: 100%;
        background-color: #005bb5;
        position: absolute;
        top: 60px;
        left: 0;
        z-index: 999;
      }

      nav ul.active {
        display: flex;
      }

      nav ul li {
        margin: 0;
        border-top: 1px solid rgba(255,255,255,0.2);
        width: 100%;
      }

      nav ul li:first-child {
        border-top: none;
      }

      nav ul li a,
      nav ul li button#logoutBtn {
        padding: 10px 20px;
        display: block;
        text-align: left;
      }

      .hamburger {
        display: block;
      }
    }

    /* Footer */
    footer {
      background: #007bff;
      color: white;
      text-align: center;
      padding: 15px;
      margin-top: 40px;
      user-select: none;
    }
  </style>
</head>
<body>

<header>
  Pagla Clickers Jobs
  <button class="hamburger" id="hamburger" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="navList">â˜°</button>
</header>

<nav>
  <ul id="navList">
    <li><a href="about.html">About</a></li>
    <li><a href="notifications.html">Notifications</a></li>
    <li><a href="profile.html">Profile</a></li>
    <li><a href="dashboard.html">Dashboard</a></li>
    <li><a href="postjob.html">Post Job</a></li>
    <li><a href="taskdetail.html" aria-current="page">Tasks</a></li>
    <li><a href="referel.html">Referral</a></li>
    <li><a href="deposit.html">Deposit</a></li>
    <li><a href="wallet.html">Wallet</a></li>
    <li><a href="withdrawal.html">Withdraw Money</a></li>
    <li><a href="terms.html">Terms</a></li>
    <li><a href="faq.html">FAQ</a></li>
    <li><a href="support.html">Support</a></li>
    <li><button id="logoutBtn">Logout</button></li>
  </ul>
</nav>

<div class="blue-strip-below-nav"></div>

<h2>Available Jobs</h2>
<div id="jobsContainer">Loading...</div>

<!-- Modal -->
<div id="jobModal" role="dialog" aria-modal="true">
  <div id="jobModalContent">
    <button class="closeBtn" onclick="closeModal()" aria-label="Close modal">X</button>
    <h3 id="jobTitle"></h3>
    <div id="jobDetails"></div>
    <form id="proofForm"></form>
    <button id="submitBtn" style="display: none;">Submit Proof</button>
    <p id="submitStatus"></p>
  </div>
</div>

<footer>
  <p>&copy; 2025 Pagla Clickers. All rights reserved.</p>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
  import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAg-6k48R9c7ZK0xGe0BtNOa-5lF5JfmdI",
    authDomain: "pagla-b1c17.firebaseapp.com",
    projectId: "pagla-b1c17",
    storageBucket: "pagla-b1c17.appspot.com",
    messagingSenderId: "192578902502",
    appId: "1:192578902502:web:4b441210b15cfebf008ecf"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

  const jobsContainer = document.getElementById("jobsContainer");
  const jobModal = document.getElementById("jobModal");
  const jobTitle = document.getElementById("jobTitle");
  const jobDetails = document.getElementById("jobDetails");
  const proofForm = document.getElementById("proofForm");
  const submitBtn = document.getElementById("submitBtn");
  const submitStatus = document.getElementById("submitStatus");
  const logoutBtn = document.getElementById("logoutBtn");

  let currentUser = null;
  let currentJob = null;
  let jobList = [];

  logoutBtn.addEventListener('click', () => {
    signOut(auth).then(() => {
      window.location.href = 'login.html';
    }).catch((error) => {
      alert('Error signing out: ' + error.message);
    });
  });

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      await loadJobs();
    } else {
      jobsContainer.innerHTML = "<p style='padding:20px; text-align:center;'>Please log in to view jobs.</p>";
    }
  });

  async function loadJobs() {
    const jobSnap = await getDocs(collection(db, "jobs"));
    jobList = [];

    await Promise.all(jobSnap.docs.map(async (docSnap) => {
      const data = docSnap.data();
      const jobId = docSnap.id;

      const subsSnap = await getDocs(collection(db, `jobs/${jobId}/submissions`));
      const submittedCount = subsSnap.size;

      jobList.push({ id: jobId, ...data, submitted: submittedCount });
    }));

    renderJobs();
  }

  function renderJobs() {
    jobsContainer.innerHTML = "";
    jobList.forEach(job => {
      const submitted = job.submitted || 0;
      const slots = job.slots || "âˆž";
      const slotInfo = slots === "âˆž" ? "Unlimited slots" : `${submitted} / ${slots} slots used`;
      const isOwner = job.ownerId === currentUser?.uid;
      const crown = isOwner ? " ðŸ‘‘ Your Job" : "";

      const div = document.createElement("div");
      div.className = "job";
      div.innerHTML = `
        <div class="job-title">${job.title}${crown}</div>
        <p>Reward: $${job.reward}</p>
        <p>Category: ${job.category}</p>
        <p>Slots: ${slotInfo}</p>
        <button class="viewBtn" onclick="openModal('${job.id}')">View & Submit</button>
      `;
      jobsContainer.appendChild(div);
    });
  }

  window.openModal = async (jobId) => {
    currentJob = jobList.find(j => j.id === jobId);
    if (!currentJob) return;

    if (currentJob.ownerId === currentUser.uid) {
      jobTitle.textContent = "Your Own Job";
      jobDetails.innerHTML = `<p><strong>Description:</strong> ${currentJob.description || "No description available."}</p><p>You cannot submit to your own job.</p>`;
      proofForm.innerHTML = "";
      submitBtn.style.display = "none";
      submitStatus.textContent = "";
      jobModal.style.display = "flex";
      return;
    }

    const submissionDoc = await getDoc(doc(db, `jobs/${jobId}/submissions/${currentUser.uid}`));
    if (submissionDoc.exists()) {
      jobTitle.textContent = "Already Submitted";
      jobDetails.innerHTML = `<p><strong>Description:</strong> ${currentJob.description || "No description available."}</p><p>You have already submitted proof for this job.</p>`;
      proofForm.innerHTML = "";
      submitBtn.style.display = "none";
    } else {
      jobTitle.textContent = currentJob.title;
      jobDetails.innerHTML = `<p><strong>Description:</strong> ${currentJob.description || "No description available."}</p><p>Submit the following proofs:</p>`;
      proofForm.innerHTML = "";

      const proofs = (currentJob.proofType || "").split(',').map(p => p.trim()).filter(Boolean);
      proofs.forEach((type, index) => {
        const label = document.createElement("label");
        label.textContent = `Proof ${index + 1} (${type})`;
        const input = document.createElement("input");
        if (type === "text") input.type = "text";
        else if (type === "screenshot") {
          input.type = "file";
          input.accept = "image/*";
        }
        input.name = `proof${index + 1}`;
        input.required = true;
        input.className = "proof-input";
        proofForm.appendChild(label);
        proofForm.appendChild(input);
      });

      submitBtn.style.display = "block";
    }

    submitStatus.textContent = "";
    jobModal.style.display = "flex";
  };

  submitBtn.onclick = async (e) => {
    e.preventDefault();
    const inputs = proofForm.querySelectorAll("input");
    const proofData = {};
    submitStatus.style.color = "black";
    submitStatus.textContent = "Uploading proofs... Please wait.";

    async function uploadFile(file, proofName) {
      return new Promise((resolve, reject) => {
        const fileName = `${currentUser.uid}_${currentJob.id}_${proofName}_${Date.now()}`;
        const storageReference = storageRef(storage, `submissions/${fileName}`);
        const uploadTask = uploadBytesResumable(storageReference, file);

        uploadTask.on('state_changed',
          () => {},
          (error) => reject(error),
          () => {
            getDownloadURL(uploadTask.snapshot.ref).then(url => resolve(url));
          }
        );
      });
    }

    try {
      for (const input of inputs) {
        if (input.type === "text") {
          if (!input.value.trim()) {
            submitStatus.style.color = "red";
            submitStatus.textContent = "Please fill all text fields.";
            return;
          }
          proofData[input.name] = input.value.trim();
        } else if (input.type === "file") {
          if (!input.files[0]) {
            submitStatus.style.color = "red";
            submitStatus.textContent = "Please select all screenshots.";
            return;
          }
          const url = await uploadFile(input.files[0], input.name);
          proofData[input.name] = url;
        }
      }

      await setDoc(doc(db, `jobs/${currentJob.id}/submissions/${currentUser.uid}`), {
        userId: currentUser.uid,
        userEmail: currentUser.email,
        timestamp: new Date(),
        proofs: proofData
      });

      submitStatus.style.color = "green";
      submitStatus.textContent = "âœ… Submission successful!";
      submitBtn.style.display = "none";
      currentJob.submitted = (currentJob.submitted || 0) + 1;
      renderJobs();
    } catch (err) {
      submitStatus.style.color = "red";
      submitStatus.textContent = "âŒ Submission failed: " + err.message;
    }
  };

  window.closeModal = () => {
    jobModal.style.display = "none";
    currentJob = null;
    proofForm.innerHTML = "";
    submitStatus.textContent = "";
  };

  const hamburger = document.getElementById("hamburger");
  const navList = document.getElementById("navList");

  hamburger.addEventListener("click", () => {
    const expanded = hamburger.getAttribute("aria-expanded") === "true" || false;
    hamburger.setAttribute("aria-expanded", !expanded);
    navList.classList.toggle("active");
  });

  hamburger.addEventListener("keydown", e => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      const expanded = hamburger.getAttribute("aria-expanded") === "true" || false;
      hamburger.setAttribute("aria-expanded", !expanded);
      navList.classList.toggle("active");
    }
  });
</script>

</body>
</html>
