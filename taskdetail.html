<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pagla Clickers - Tasks</title>
<style>
  body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 0; }
  header, footer { background: #007bff; color: white; text-align: center; padding: 10px; }
  #jobsContainer { padding: 20px; max-width: 800px; margin: 0 auto; }
  .job { display: flex; justify-content: space-between; padding: 10px; background: white; margin-bottom: 10px; border-radius: 5px; }
  .job-left { display: flex; align-items: center; }
  .reward { font-weight: bold; font-size: 18px; color: green; margin-right: 15px; }
  .job-title { font-weight: bold; }
  .badge { padding: 3px 8px; border-radius: 4px; font-size: 12px; color: white; margin-left: 8px; }
  .badge-own { background: purple; }
  .badge-completed { background: gray; }
  .badge-available { background: orange; }
  .job-right { display: flex; flex-direction: column; justify-content: center; }
  .job-stats { font-size: 12px; color: #666; margin-top: 5px; }
  .viewDetailsLink { color: #007bff; cursor: pointer; text-decoration: underline; font-size: 14px; }
  /* Modal styles */
  #jobModal {
    display: none;
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    justify-content: center; align-items: center;
  }
  #jobModalContent {
    background: white; padding: 20px; border-radius: 8px; width: 400px; max-height: 90vh; overflow-y: auto;
    position: relative;
  }
  #closeModal {
    position: absolute; top: 10px; right: 10px; cursor: pointer; font-weight: bold; font-size: 18px;
  }
  label { display: block; margin-top: 12px; font-weight: bold; }
  textarea { width: 100%; height: 70px; margin-top: 5px; }
  input[type="file"] { margin-top: 5px; }
  #submissionStatus { margin-top: 10px; font-weight: bold; color: green; }
  #modalMessage { color: red; margin-top: 10px; font-weight: bold; }
  button { margin-top: 15px; padding: 10px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
  button:disabled { background: gray; cursor: not-allowed; }
  #searchInput, #categoryFilter, #sortFilter {
    margin: 10px 10px 20px 10px;
    padding: 5px 10px;
    font-size: 14px;
  }
</style>
</head>
<body>

<header>
  <h1>Pagla Clickers - Available Tasks</h1>
</header>

<div style="max-width: 800px; margin: 20px auto; display: flex; gap: 10px;">
  <input type="text" id="searchInput" placeholder="Search tasks..." />
  <select id="categoryFilter">
    <option value="">All Categories</option>
    <option value="marketing">Marketing</option>
    <option value="design">Design</option>
    <option value="writing">Writing</option>
    <!-- Add more categories as needed -->
  </select>
  <select id="sortFilter">
    <option value="rewardDesc">Sort by Reward: High to Low</option>
    <option value="rewardAsc">Sort by Reward: Low to High</option>
  </select>
</div>

<div id="jobsContainer">
  <!-- Jobs will be loaded here -->
</div>

<!-- Job Details Modal -->
<div id="jobModal">
  <div id="jobModalContent">
    <span id="closeModal">&times;</span>
    <h2 id="modalJobTitle"></h2>
    <p id="modalJobDesc"></p>
    <p><strong>Reward:</strong> $<span id="modalJobReward"></span></p>
    <p><strong>Slots:</strong> <span id="modalJobSlots"></span></p>
    <p><strong>Submissions:</strong> <span id="modalJobSubmissions"></span></p>

    <div id="submissionSection" style="margin-top: 15px;">
      <form id="proofForm">
        <div id="proofInput"></div>
        <button type="button" id="submitProofBtn">Submit</button>
      </form>
      <div id="submissionStatus" style="display:none;"></div>
      <div id="modalMessage"></div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    doc,
    getDoc,
    setDoc
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
  import {
    getStorage,
    ref as storageRef,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAg-6k48R9c7ZK0xGe0BtNOa-5lF5JfmdI",
    authDomain: "pagla-b1c17.firebaseapp.com",
    projectId: "pagla-b1c17",
    storageBucket: "pagla-b1c17.appspot.com",
    messagingSenderId: "192578902502",
    appId: "1:192578902502:web:4b441210b15cfebf008ecf",
    measurementId: "G-2Z08RL7X9H"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

  let currentUser = null;
  let allJobs = [];

  const jobsContainer = document.getElementById('jobsContainer');
  const searchInput = document.getElementById('searchInput');
  const categoryFilter = document.getElementById('categoryFilter');
  const sortFilter = document.getElementById('sortFilter');

  // Modal elements
  const jobModal = document.getElementById('jobModal');
  const closeModalBtn = document.getElementById('closeModal');
  const modalJobTitle = document.getElementById('modalJobTitle');
  const modalJobDesc = document.getElementById('modalJobDesc');
  const modalJobReward = document.getElementById('modalJobReward');
  const modalJobSlots = document.getElementById('modalJobSlots');
  const modalJobSubmissions = document.getElementById('modalJobSubmissions');
  const submissionSection = document.getElementById('submissionSection');
  const proofInput = document.getElementById('proofInput');
  const submitProofBtn = document.getElementById('submitProofBtn');
  const submissionStatus = document.getElementById('submissionStatus');
  const modalMessage = document.getElementById('modalMessage');

  let currentJobInModal = null;

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      await loadJobs();
      applyFilters();
    } else {
      jobsContainer.innerHTML = "<p>Please log in to see and submit tasks.</p>";
    }
  });

  async function loadJobs() {
    const jobsSnapshot = await getDocs(collection(db, "jobs"));
    const jobsTemp = [];

    for (const docSnap of jobsSnapshot.docs) {
      const jobData = docSnap.data();
      // Check if user submitted for this job
      const submissionDoc = await getDoc(doc(db, "jobs", docSnap.id, "submissions", currentUser.uid));
      const hasSubmitted = submissionDoc.exists();

      jobsTemp.push({
        id: docSnap.id,
        title: jobData.title || "No title",
        category: jobData.category || "",
        reward: Number(jobData.reward) || 0,
        totalSlots: Number(jobData.slots) || 0,
        submissions: Number(jobData.submissions) || 0,
        ownerId: jobData.ownerId || "",
        hasSubmitted: hasSubmitted,
        isOwnJob: (jobData.ownerId === currentUser.uid),
        proofType: jobData.proofType || ["text"]  // Expecting array e.g. ["text","ss"]
      });
    }

    allJobs = jobsTemp;
  }

  function renderJobs(jobs) {
    jobsContainer.innerHTML = "";

    if (jobs.length === 0) {
      jobsContainer.innerHTML = "<p>No tasks match your criteria.</p>";
      return;
    }

    jobs.forEach((job, index) => {
      const isOwnJob = job.isOwnJob;
      const isCompleted = (job.submissions >= job.totalSlots);
      let badgeText = "";
      let badgeClass = "";

      if (isOwnJob) {
        badgeText = "ðŸ‘‘ Your Job";
        badgeClass = "badge-own";
      } else if (isCompleted) {
        badgeText = "âœ… Completed";
        badgeClass = "badge-completed";
      } else {
        badgeText = "ðŸ”¥ Available";
        badgeClass = "badge-available";
      }

      const jobEl = document.createElement('div');
      jobEl.classList.add('job');

      jobEl.innerHTML = `
        <div class="job-left">
          <div class="reward">$${job.reward.toFixed(2)}</div>
          <div>
            <div class="job-title" title="${job.title}">${job.title} <span class="badge ${badgeClass}">${badgeText}</span></div>
          </div>
        </div>
        <div class="job-right">
          <a href="#" class="viewDetailsLink" data-job-index="${index}">View Details</a>
          <div class="job-stats">${job.submissions}/${job.totalSlots} Done</div>
        </div>
      `;

      jobsContainer.appendChild(jobEl);
    });

    // Add click listeners for all "View Details" links
    document.querySelectorAll('.viewDetailsLink').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const index = e.target.getAttribute('data-job-index');
        openJobModal(allJobs[index]);
      });
    });
  }

  function applyFilters() {
    const searchTerm = searchInput.value.trim().toLowerCase();
    const selectedCategory = categoryFilter.value;
    const sortOrder = sortFilter.value;

    let filteredJobs = allJobs;

    if (selectedCategory) {
      filteredJobs = filteredJobs.filter(job => job.category.toLowerCase() === selectedCategory.toLowerCase());
    }

    if (searchTerm) {
      filteredJobs = filteredJobs.filter(job => job.title.toLowerCase().includes(searchTerm));
    }

    if (sortOrder === "rewardAsc") {
      filteredJobs.sort((a, b) => a.reward - b.reward);
    } else {
      filteredJobs.sort((a, b) => b.reward - a.reward);
    }

    renderJobs(filteredJobs);
  }

  searchInput.addEventListener('input', applyFilters);
  categoryFilter.addEventListener('change', applyFilters);
  sortFilter.addEventListener('change', applyFilters);

  // Modal functions
  closeModalBtn.onclick = () => {
    closeJobModal();
  };

  window.onclick = (event) => {
    if (event.target === jobModal) {
      closeJobModal();
    }
  };

  function openJobModal(job) {
    currentJobInModal = job;

    modalJobTitle.textContent = job.title;
    modalJobDesc.textContent = `Category: ${job.category.charAt(0).toUpperCase() + job.category.slice(1)}`;
    modalJobReward.textContent = job.reward.toFixed(2);
    modalJobSlots.textContent = job.totalSlots;
    modalJobSubmissions.textContent = job.submissions;

    submissionStatus.style.display = 'none';
    modalMessage.textContent = '';
    submitProofBtn.style.display = 'inline-block';
    submitProofBtn.disabled = false;
    submitProofBtn.textContent = "Submit";

    // Clear previous proof inputs
    proofInput.innerHTML = '';

    if (job.proofType && Array.isArray(job.proofType)) {
      job.proofType.forEach((type, index) => {
        const stepNumber = index + 1;
        const label = document.createElement('label');
        label.htmlFor = `proof${stepNumber}`;
        label.textContent = `Proof Step ${stepNumber}: ${type === 'ss' ? 'Upload Screenshot' : 'Enter Text'}`;
        proofInput.appendChild(label);

        if (type === 'ss') {
          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.accept = 'image/*';
          fileInput.id = `proof${stepNumber}`;
          proofInput.appendChild(fileInput);
        } else {
          const textarea = document.createElement('textarea');
          textarea.id = `proof${stepNumber}`;
          textarea.placeholder = `Enter proof text for step ${stepNumber}...`;
          proofInput.appendChild(textarea);
        }
      });
    } else {
      // fallback
      const textarea = document.createElement('textarea');
      textarea.id = 'proof1';
      textarea.placeholder = 'Enter proof text...';
      proofInput.appendChild(textarea);
    }

    if (!job.hasSubmitted && !job.isOwnJob && job.submissions < job.totalSlots) {
      submissionSection.style.display = 'block';
    } else {
      submissionSection.style.display = 'none';
      if (job.isOwnJob) {
        modalMessage.textContent = "You cannot submit proof to your own job.";
      } else if (job.hasSubmitted) {
        modalMessage.textContent = "You have already submitted proof for this job.";
      } else if (job.submissions >= job.totalSlots) {
        modalMessage.textContent = "This job has already been completed.";
      }
    }

    jobModal.style.display = 'flex';
  }

  function closeJobModal() {
    jobModal.style.display = 'none';
    currentJobInModal = null;
  }

  submitProofBtn.onclick = async () => {
    modalMessage.textContent = "";

    if (!currentJobInModal || !currentJobInModal.proofType) {
      modalMessage.textContent = "Invalid job proof requirements.";
      return;
    }

    submitProofBtn.disabled = true;
    submitProofBtn.textContent = "Submitting...";

    try {
      const proofs = {};

      for (let i = 0; i < currentJobInModal.proofType.length; i++) {
        const step = i + 1;
        const proofType = currentJobInModal.proofType[i];
        const inputEl = document.getElementById(`proof${step}`);

        if (!inputEl) throw new Error(`Proof input for step ${step} not found.`);

        if (proofType === 'ss') {
          if (inputEl.files.length === 0) {
            throw new Error(`Please upload a screenshot for proof step ${step}.`);
          }

          const file = inputEl.files[0];
          const storagePath = `jobProofs/${currentJobInModal.id}/${currentUser.uid}/proof${step}_${Date.now()}_${file.name}`;
          const proofStorageRef = storageRef(storage, storagePath);

          await uploadBytes(proofStorageRef, file);

          const downloadURL = await getDownloadURL(proofStorageRef);
          proofs[`proof${step}`] = {
            type: 'ss',
            url: downloadURL,
            name: file.name
          };

        } else {
          const val = inputEl.value.trim();
          if (!val) {
            throw new Error(`Please enter text for proof step ${step}.`);
          }
          proofs[`proof${step}`] = {
            type: 'text',
            content: val
          };
        }
      }

      const submissionRef = doc(db, `jobs/${currentJobInModal.id}/submissions`, currentUser.uid);

      await setDoc(submissionRef, {
        proofs,
        timestamp: new Date(),
        userId: currentUser.uid,
        userEmail: currentUser.email
      });

      submissionStatus.style.display = 'block';
      submissionStatus.textContent = "Submitted successfully!";
      submitProofBtn.style.display = 'none';
      proofInput.style.display = 'none';

      currentJobInModal.submissions += 1;
      currentJobInModal.hasSubmitted = true;
      modalJobSubmissions.textContent = currentJobInModal.submissions;

      applyFilters();

    } catch (error) {
      modalMessage.textContent = "Error submitting proof: " + error.message;
    } finally {
      submitProofBtn.disabled = false;
      submitProofBtn.textContent = "Submit";
    }
  };
</script>

<footer>
  <p>Â© 2025 Pagla Clickers</p>
</footer>

</body>
</html>
