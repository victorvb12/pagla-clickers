<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pagla Clickers - Task Detail</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 0; }
    #jobsContainer { max-width: 700px; margin: 20px auto; }
    .job { background: white; margin-bottom: 15px; padding: 10px 15px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px #ddd; }
    .job-title { font-weight: bold; font-size: 18px; }
    .badge { padding: 2px 8px; border-radius: 12px; font-size: 12px; color: white; margin-left: 8px; }
    .badge-own { background: #6c757d; }
    .badge-completed { background: #28a745; }
    .badge-available { background: #dc3545; }
    .job-stats { font-size: 14px; color: #555; }
    a.viewDetailsLink { cursor: pointer; color: #007bff; text-decoration: none; }
    a.viewDetailsLink:hover { text-decoration: underline; }
    #jobModal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #jobModal > div {
      background: white;
      max-width: 600px;
      width: 90%;
      border-radius: 6px;
      padding: 20px;
      position: relative;
    }
    #closeModal {
      position: absolute;
      right: 15px; top: 10px;
      font-size: 25px;
      font-weight: bold;
      cursor: pointer;
      color: #333;
    }
    label { display: block; margin-top: 10px; font-weight: bold; }
    textarea { width: 100%; height: 100px; margin-top: 5px; resize: vertical; }
    input[type="file"] { margin-top: 5px; }
    #submitProofBtn {
      margin-top: 15px;
      background: #007bff;
      color: white;
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    #submitProofBtn:disabled {
      background: #a0c6ff;
      cursor: not-allowed;
    }
    #submissionStatus {
      margin-top: 10px;
      font-weight: bold;
      color: green;
      display: none;
    }
    #modalMessage {
      margin-top: 10px;
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div id="jobsContainer"></div>

<div id="jobModal">
  <div>
    <span id="closeModal">&times;</span>
    <h2 id="modalJobTitle"></h2>
    <p id="modalJobDesc"></p>
    <p><strong>Reward:</strong> $<span id="modalJobReward"></span></p>
    <p><strong>Slots:</strong> <span id="modalJobSlots"></span></p>
    <p><strong>Submissions:</strong> <span id="modalJobSubmissions"></span></p>

    <div id="submissionSection">
      <form id="proofForm">
        <div id="proofInput"></div>
        <button type="button" id="submitProofBtn">Submit</button>
      </form>
    </div>

    <div id="submissionStatus"></div>
    <div id="modalMessage"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    doc,
    getDoc,
    setDoc
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
  import {
    getStorage,
    ref as storageRef,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAg-6k48R9c7ZK0xGe0BtNOa-5lF5JfmdI",
    authDomain: "pagla-b1c17.firebaseapp.com",
    projectId: "pagla-b1c17",
    storageBucket: "pagla-b1c17.appspot.com",
    messagingSenderId: "192578902502",
    appId: "1:192578902502:web:4b441210b15cfebf008ecf",
    measurementId: "G-2Z08RL7X9H"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

  let currentUser = null;
  let allJobs = [];

  const jobsContainer = document.getElementById('jobsContainer');
  const jobModal = document.getElementById('jobModal');
  const closeModalBtn = document.getElementById('closeModal');
  const modalJobTitle = document.getElementById('modalJobTitle');
  const modalJobDesc = document.getElementById('modalJobDesc');
  const modalJobReward = document.getElementById('modalJobReward');
  const modalJobSlots = document.getElementById('modalJobSlots');
  const modalJobSubmissions = document.getElementById('modalJobSubmissions');
  const submissionSection = document.getElementById('submissionSection');
  const proofInput = document.getElementById('proofInput');
  const submitProofBtn = document.getElementById('submitProofBtn');
  const submissionStatus = document.getElementById('submissionStatus');
  const modalMessage = document.getElementById('modalMessage');

  let currentJobInModal = null;

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      await loadJobs();
      renderJobs(allJobs);
    } else {
      jobsContainer.innerHTML = "<p>Please log in to see and submit tasks.</p>";
    }
  });

  async function loadJobs() {
    const jobsSnapshot = await getDocs(collection(db, "jobs"));
    const jobsTemp = [];

    for (const docSnap of jobsSnapshot.docs) {
      const jobData = docSnap.data();

      const submissionDoc = await getDoc(doc(db, "jobs", docSnap.id, "submissions", currentUser.uid));
      const hasSubmitted = submissionDoc.exists();

      jobsTemp.push({
        id: docSnap.id,
        title: jobData.title || "No title",
        category: jobData.category || "",
        reward: Number(jobData.reward) || 0,
        totalSlots: Number(jobData.slots) || 0,
        submissions: Number(jobData.submissions) || 0,
        ownerId: jobData.ownerId || "",
        hasSubmitted: hasSubmitted,
        isOwnJob: (jobData.ownerId === currentUser.uid),
        proofType: jobData.proofType || "text" // default to text if missing
      });
    }

    allJobs = jobsTemp;
  }

  function renderJobs(jobs) {
    jobsContainer.innerHTML = "";

    if (jobs.length === 0) {
      jobsContainer.innerHTML = "<p>No tasks available.</p>";
      return;
    }

    jobs.forEach((job, index) => {
      const isOwnJob = job.isOwnJob;
      const isCompleted = (job.submissions >= job.totalSlots);
      let badgeText = "";
      let badgeClass = "";

      if (isOwnJob) {
        badgeText = "ðŸ‘‘ Your Job";
        badgeClass = "badge-own";
      } else if (isCompleted) {
        badgeText = "âœ… Completed";
        badgeClass = "badge-completed";
      } else {
        badgeText = "ðŸ”¥ Available";
        badgeClass = "badge-available";
      }

      const jobEl = document.createElement('div');
      jobEl.classList.add('job');

      jobEl.innerHTML = `
        <div>
          <div class="job-title" title="${job.title}">${job.title} <span class="badge ${badgeClass}">${badgeText}</span></div>
          <div>Reward: $${job.reward.toFixed(2)} | Slots: ${job.submissions}/${job.totalSlots}</div>
        </div>
        <div>
          <a href="#" class="viewDetailsLink" data-job-index="${index}">View Details</a>
        </div>
      `;

      jobsContainer.appendChild(jobEl);
    });

    document.querySelectorAll('.viewDetailsLink').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const index = e.target.getAttribute('data-job-index');
        openJobModal(allJobs[index]);
      });
    });
  }

  closeModalBtn.onclick = () => {
    closeJobModal();
  };

  window.onclick = (event) => {
    if (event.target === jobModal) {
      closeJobModal();
    }
  };

  function clearProofInputs() {
    proofInput.innerHTML = '';
  }

  function openJobModal(job) {
    currentJobInModal = job;

    modalJobTitle.textContent = job.title;
    modalJobDesc.textContent = `Category: ${job.category.charAt(0).toUpperCase() + job.category.slice(1)}`;
    modalJobReward.textContent = job.reward.toFixed(2);
    modalJobSlots.textContent = job.totalSlots;
    modalJobSubmissions.textContent = job.submissions;

    submissionStatus.style.display = 'none';
    modalMessage.textContent = '';
    submitProofBtn.style.display = 'inline-block';
    submitProofBtn.disabled = false;
    submitProofBtn.textContent = "Submit";

    clearProofInputs();

    if (!job.hasSubmitted && !job.isOwnJob && job.submissions < job.totalSlots) {
      // Show inputs based on proofType
      submissionSection.style.display = 'block';

      if (job.proofType === 'text') {
        const label = document.createElement('label');
        label.htmlFor = 'proofText';
        label.textContent = 'Enter Proof Text:';
        proofInput.appendChild(label);

        const textarea = document.createElement('textarea');
        textarea.id = 'proofText';
        textarea.placeholder = 'Enter proof text here...';
        proofInput.appendChild(textarea);

      } else if (job.proofType === 'ss') {
        const label = document.createElement('label');
        label.htmlFor = 'proofSS';
        label.textContent = 'Upload Screenshot Proof:';
        proofInput.appendChild(label);

        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.id = 'proofSS';
        proofInput.appendChild(fileInput);

      } else if (job.proofType === 'both') {
        // Text area first
        const labelText = document.createElement('label');
        labelText.htmlFor = 'proofText';
        labelText.textContent = 'Enter Proof Text:';
        proofInput.appendChild(labelText);

        const textarea = document.createElement('textarea');
        textarea.id = 'proofText';
        textarea.placeholder = 'Enter proof text here...';
        proofInput.appendChild(textarea);

        // File input second
        const labelSS = document.createElement('label');
        labelSS.htmlFor = 'proofSS';
        labelSS.textContent = 'Upload Screenshot Proof:';
        proofInput.appendChild(labelSS);

        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.id = 'proofSS';
        proofInput.appendChild(fileInput);
      } else {
        // fallback: text input
        const label = document.createElement('label');
        label.htmlFor = 'proofText';
        label.textContent = 'Enter Proof Text:';
        proofInput.appendChild(label);

        const textarea = document.createElement('textarea');
        textarea.id = 'proofText';
        textarea.placeholder = 'Enter proof text here...';
        proofInput.appendChild(textarea);
      }

    } else {
      submissionSection.style.display = 'none';

      if (job.isOwnJob) {
        modalMessage.textContent = "You cannot submit proof to your own job.";
      } else if (job.hasSubmitted) {
        modalMessage.textContent = "You have already submitted proof for this job.";
      } else if (job.submissions >= job.totalSlots) {
        modalMessage.textContent = "This job has already been completed.";
      }
    }

    jobModal.style.display = 'flex';
  }

  function closeJobModal() {
    jobModal.style.display = 'none';
    currentJobInModal = null;
  }

  submitProofBtn.onclick = async () => {
    modalMessage.textContent = "";

    if (!currentJobInModal || !currentJobInModal.proofType) {
      modalMessage.textContent = "Invalid job proof requirements.";
      return;
    }

    submitProofBtn.disabled = true;
    submitProofBtn.textContent = "Submitting...";

    try {
      const proofType = currentJobInModal.proofType;
      const proofs = {};

      if (proofType === 'text') {
        const textInput = document.getElementById('proofText');
        if (!textInput || !textInput.value.trim()) {
          throw new Error("Please enter proof text.");
        }
        proofs.text = textInput.value.trim();

      } else if (proofType === 'ss') {
        const fileInput = document.getElementById('proofSS');
        if (!fileInput || fileInput.files.length === 0) {
          throw new Error("Please upload a screenshot.");
        }
        const file = fileInput.files[0];
        const storagePath = `jobProofs/${currentJobInModal.id}/${currentUser.uid}/proof_ss_${Date.now()}_${file.name}`;
        const proofStorageRef = storageRef(storage, storagePath);

        await uploadBytes(proofStorageRef, file);
        const downloadURL = await getDownloadURL(proofStorageRef);

        proofs.screenshotURL = downloadURL;

      } else if (proofType === 'both') {
        const textInput = document.getElementById('proofText');
        const fileInput = document.getElementById('proofSS');

        if (!textInput || !textInput.value.trim()) {
          throw new Error("Please enter proof text.");
        }
        if (!fileInput || fileInput.files.length === 0) {
          throw new Error("Please upload a screenshot.");
        }

        proofs.text = textInput.value.trim();

        const file = fileInput.files[0];
        const storagePath = `jobProofs/${currentJobInModal.id}/${currentUser.uid}/proof_ss_${Date.now()}_${file.name}`;
        const proofStorageRef = storageRef(storage, storagePath);

        await uploadBytes(proofStorageRef, file);
        const downloadURL = await getDownloadURL(proofStorageRef);

        proofs.screenshotURL = downloadURL;

      } else {
        throw new Error("Unknown proof type.");
      }

      const submissionRef = doc(db, `jobs/${currentJobInModal.id}/submissions`, currentUser.uid);

      await setDoc(submissionRef, {
        proofs,
        timestamp: new Date(),
        userId: currentUser.uid,
        userEmail: currentUser.email
      });

      submissionStatus.style.display = 'block';
      submissionStatus.textContent = "Submitted successfully!";
      submitProofBtn.style.display = 'none';
      proofInput.style.display = 'none';

      currentJobInModal.submissions += 1;
      currentJobInModal.hasSubmitted = true;
      modalJobSubmissions.textContent = currentJobInModal.submissions;

      renderJobs(allJobs);

    } catch (error) {
      modalMessage.textContent = "Error submitting proof: " + error.message;
    } finally {
      submitProofBtn.disabled = false;
      submitProofBtn.textContent = "Submit";
    }
  };
</script>

</body>
</html>
