<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pagla Clickers - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />

  <!-- scoped styles just for modal/cards; does NOT change your global nav/header/css -->
  <style>
    .job-card{background:#fff;border:1px solid #ddd;border-radius:10px;padding:16px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);cursor:pointer}
    .job-card:hover{background:#f6f8ff}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9999;padding:16px}
    .modal-overlay.show{display:flex}
    .modal-content{background:#fff;max-width:640px;width:100%;border-radius:12px;padding:20px;position:relative;box-shadow:0 10px 25px rgba(0,0,0,.2)}
    .closeBtn{position:absolute;top:10px;right:10px;background:#dc3545;color:#fff;border:none;border-radius:6px;padding:6px 10px;font-weight:700;cursor:pointer}
    .job-description-box{border:2px solid #7a5dc7;border-radius:8px;padding:12px;margin:10px 0;background:#f5f0ff;white-space:pre-wrap}
    .proof-input{width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:6px}
    .submit-proof-btn{background:#7a5dc7;color:#fff;border:none;border-radius:8px;padding:10px 16px;font-weight:700;cursor:pointer}
    .filters{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .filters input[type="search"], .filters select{padding:8px 10px;border:1px solid #9b8bc3;border-radius:6px}
  </style>
</head>
<body>

<header>
  Pagla Clickers
  <button class="hamburger" aria-label="Toggle menu" onclick="toggleMenu()">â˜°</button>
</header>

<nav>
  <ul class="nav-links" id="navList">
    <li><a href="about.html">About</a></li>
    <li><a href="notifications.html">Notifications</a></li>
    <li><a href="profile.html">Profile</a></li>
    <li><a href="dashboard.html" aria-current="page">Dashboard</a></li>
    <li><a href="postjob.html">Post Job</a></li>
    <li><a href="jobs.html">My Jobs</a></li>
    <li><a href="referral.html">Referral</a></li>
    <li><a href="deposit.html">Deposit</a></li>
    <li><a href="wallet.html">Wallet</a></li>
    <li><a href="withdrawal.html">Withdraw Money</a></li>
    <li><a href="terms.html">Terms</a></li>
    <li><a href="faq.html">FAQ</a></li>
    <li><a href="support.html">Support</a></li>
    <li style="display:flex;justify-content:center;align-items:center;">
      <button id="logoutBtn" type="button" class="logout-btn" style="width:auto;max-width:100%;text-align:center;">Logout</button>
    </li>
  </ul>
</nav>

<div class="blue-strip-below-nav"></div>

<main class="container" role="main" tabindex="0">
  <h2>Welcome, <span id="userName">Loading...</span></h2>
  <p>Your Balance: <strong id="userBalance">à§³0.00</strong></p>

  <hr style="margin:20px 0;border-color:#ddd" />

  <h2>Available Jobs</h2>
  <p id="jobCount" style="font-weight:600;margin:6px 0 12px">Loading jobs...</p>

  <div class="filters" aria-label="Job filters">
    <input type="search" id="searchInput" placeholder="Search jobs..." />
    <select id="categoryFilter">
      <option value="">All Categories</option>
    </select>
    <select id="sortSelect">
      <option value="default">Default</option>
      <option value="priceAsc">Price: Low to High</option>
      <option value="priceDesc">Price: High to Low</option>
    </select>
  </div>

  <section id="jobsContainer" aria-live="polite">Loading...</section>
</main>

<footer>
  <p>&copy; 2025 Pagla Clickers. All rights reserved.</p>
</footer>

<script>
  // keep the same hamburger behavior used across your pages
  function toggleMenu() {
    const navList = document.getElementById('navList');
    navList.classList.toggle('active');
    const logoutBtn = document.getElementById('logoutBtn');
    if (window.innerWidth <= 768) {
      logoutBtn.style.width = '90%';
    } else {
      logoutBtn.style.width = 'auto';
    }
  }
  document.addEventListener('DOMContentLoaded', () => {
    const logoutBtn = document.getElementById('logoutBtn');
    if (window.innerWidth <= 768) logoutBtn.style.width = '90%';
  });
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
  import {
    getFirestore,
    doc, getDoc,
    collection, getDocs, query, where, setDoc, orderBy,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
  import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAg-6k48R9c7ZK0xGe0BtNOa-5lF5JfmdI",
    authDomain: "pagla-b1c17.firebaseapp.com",
    projectId: "pagla-b1c17",
    storageBucket: "pagla-b1c17.appspot.com",
    messagingSenderId: "192578902502",
    appId: "1:192578902502:web:1595070cdac289170f5e27"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const userNameEl = document.getElementById('userName');
  const userBalanceEl = document.getElementById('userBalance');
  const logoutBtn = document.getElementById('logoutBtn');

  const jobsContainer = document.getElementById("jobsContainer");
  const jobCount = document.getElementById("jobCount");
  const searchInput = document.getElementById("searchInput");
  const categoryFilter = document.getElementById("categoryFilter");
  const sortSelect = document.getElementById("sortSelect");

  // Modal elements
  const modal = (() => {
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.id = 'jobModal';
    overlay.innerHTML = `
      <div class="modal-content">
        <button class="closeBtn" id="modalCloseBtn" aria-label="Close">Close</button>
        <h3 id="jobTitle"></h3>
        <div id="modalMeta" style="font-weight:600;line-height:1.4;margin-bottom:8px;"></div>
        <div class="job-description-box" id="jobDesc"></div>
        <form id="proofForm"></form>
        <button id="submitBtn" class="submit-proof-btn" style="margin-top:12px;display:none;">Submit Proof</button>
        <p id="submitStatus" style="margin-top:8px;font-weight:600;"></p>
      </div>`;
    document.body.appendChild(overlay);
    overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeModal(); });
    overlay.querySelector('#modalCloseBtn').addEventListener('click', closeModal);
    return overlay;
  })();

  function closeModal(){
    modal.classList.remove('show');
    document.getElementById('proofForm').innerHTML = '';
    document.getElementById('submitStatus').textContent = '';
    document.getElementById('submitBtn').style.display = 'none';
    currentJob = null;
  }

  let currentUser = null;
  let jobList = [];
  let filteredList = [];
  let currentJob = null;

  logoutBtn.addEventListener('click', () => {
    signOut(auth).then(()=>location.href='login.html')
      .catch(err=>alert('Error signing out: '+err.message));
  });

  onAuthStateChanged(auth, async (user) => {
    if (!user) { location.href = 'login.html'; return; }
    currentUser = user;

    const u = await getDoc(doc(db, "users", user.uid));
    userNameEl.textContent = u.exists() ? (u.data().username || 'User') : 'User';
    userBalanceEl.textContent = 'à§³' + (u.exists() ? Number(u.data().balance ?? 0).toFixed(2) : '0.00');

    await loadJobs();
  });

  // Load only approved jobs; avoid N+1 reads
  async function loadJobs() {
    try {
      const jobsCol = collection(db, "jobs");
      // const qy = query(jobsCol, where("status","==","approved"), orderBy("createdAt","desc"));
      const qy = query(jobsCol, where("status","==","approved"));
      const snap = await getDocs(qy);

      jobList = [];
      snap.forEach(d=>{
        const data = d.data();
        const completed = Number(data.completed || 0);
        const slots = data.slots === undefined ? null : Number(data.slots);
        const filled = Number.isFinite(slots) && completed >= slots;
        if (!filled) jobList.push({ id:d.id, ...data });
      });

      populateCategoryFilter();
      applyFilters(); // initial
    } catch (e) {
      jobsContainer.innerHTML = `<p style="color:red;">Failed to load jobs: ${e.message}</p>`;
    }
  }

  function populateCategoryFilter() {
    const set = new Set();
    jobList.forEach(j=>{ if(j.category) set.add(j.category); });
    categoryFilter.innerHTML = '<option value="">All Categories</option>';
    [...set].sort().forEach(cat=>{
      const o = document.createElement('option');
      o.value = o.textContent = cat;
      categoryFilter.appendChild(o);
    });
  }

  // debounce helper
  function debounce(fn, ms=200){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

  function applyFilters(){
    const q = (searchInput.value||'').toLowerCase().trim();
    const cat = categoryFilter.value;
    const sort = sortSelect.value;

    filteredList = jobList.filter(j=>{
      const title = (j.title||'').toLowerCase();
      const okQ = !q || title.includes(q);
      const okC = !cat || j.category === cat;
      return okQ && okC;
    });

    if (sort === 'priceAsc') filteredList.sort((a,b)=>(a.reward??0)-(b.reward??0));
    else if (sort === 'priceDesc') filteredList.sort((a,b)=>(b.reward??0)-(a.reward??0));

    renderJobs();
  }

  function renderJobs(){
    jobCount.textContent = `Showing ${filteredList.length} job(s)`;
    jobsContainer.innerHTML = '';
    if (!filteredList.length){
      jobsContainer.innerHTML = '<p>No jobs found.</p>';
      return;
    }
    const frag = document.createDocumentFragment();
    filteredList.forEach(j=>{
      const completed = Number(j.completed || 0);
      const slots = j.slots === undefined ? null : Number(j.slots);
      const slotInfo = Number.isFinite(slots) ? `${completed} / ${slots} used` : 'Unlimited slots';

      const card = document.createElement('div');
      card.className = 'job-card';

      // SAFE DOM build (no innerHTML with user data)
      const h3 = document.createElement('h3');
      h3.style.cssText = 'color:#7a5dc7;margin:0 0 6px 0;font-weight:700;';
      h3.textContent = j.title || 'Untitled Job';
      if (j.userId === currentUser?.uid) h3.append(' ðŸ‘‘ Your Job');

      const meta = document.createElement('div');
      meta.style.cssText = 'color:#444;font-weight:600;display:flex;flex-direction:column;gap:3px;';
      const d1 = document.createElement('div'); d1.textContent = `Category: ${j.category || 'Uncategorized'}`;
      const d2 = document.createElement('div'); d2.textContent = `Reward: à§³${Number(j.reward ?? 0).toFixed(2)}`;
      const d3 = document.createElement('div'); d3.textContent = `Slots: ${slotInfo}`;
      meta.append(d1,d2,d3);

      card.append(h3, meta);
      card.addEventListener('click', ()=>openModal(j));
      frag.appendChild(card);
    });
    jobsContainer.appendChild(frag);
  }

  searchInput.addEventListener('input', debounce(applyFilters, 200));
  categoryFilter.addEventListener('change', applyFilters);
  sortSelect.addEventListener('change', applyFilters);

  // Modal open builds proof UI by type, blocks self & duplicates
  async function openModal(job){
    currentJob = job;

    document.getElementById('jobTitle').textContent = job.title || 'Untitled Job';
    const completed = Number(job.completed || 0);
    const slots = job.slots === undefined ? null : Number(job.slots);
    const slotInfo = Number.isFinite(slots) ? `${completed} / ${slots} used` : 'Unlimited slots';

    // SAFE DOM build (no innerHTML with user data)
    const mm = document.getElementById('modalMeta');
    mm.replaceChildren();
    [
      ['Poster', job.posterName || 'N/A'],
      ['Job ID', job.id],
      ['Category', job.category || 'Uncategorized'],
      ['Completion', slotInfo]
    ].forEach(([k,v])=>{
      const row = document.createElement('div');
      const b = document.createElement('strong'); b.textContent = `${k}: `;
      const span = document.createElement('span'); span.textContent = v;
      row.append(b, span);
      mm.appendChild(row);
    });

    document.getElementById('jobDesc').textContent = job.description || 'No description provided.';

    const proofForm = document.getElementById('proofForm');
    const submitBtn = document.getElementById('submitBtn');
    const submitStatus = document.getElementById('submitStatus');
    proofForm.innerHTML = '';
    submitStatus.textContent = '';
    submitBtn.style.display = 'none';
    submitBtn.disabled = false;

    // owner cannot submit
    if (currentUser.uid === job.userId){
      proofForm.innerHTML = `<em>You posted this job.</em>`;
      modal.classList.add('show');
      return;
    }

    // already submitted?
    const subRef = doc(db, "jobs", job.id, "submissions", currentUser.uid);
    const subSnap = await getDoc(subRef);
    if (subSnap.exists()){
      const d = subSnap.data()||{};
      proofForm.innerHTML = "<strong>Your submission:</strong>";
      ['proof1','proof2','proof3'].forEach(k=>{
        if (d[k]){
          const div = document.createElement('div');
          div.style.marginTop = '6px';
          div.textContent = `${k}: ${d[k]}`;
          proofForm.appendChild(div);
        }
      });
      modal.classList.add('show');
      return;
    }

    // build proof inputs by type
    const proofs = [];
    if (job.proofType) proofs.push(job.proofType);
    if (job.proof1) proofs.push(job.proof1);
    if (job.proof2) proofs.push(job.proof2);
    if (job.proof3) proofs.push(job.proof3);
    const clean = proofs.filter(p=>p && p.toLowerCase()!=='none');

    function addText(labelText, name){
      const lbl = document.createElement('label'); lbl.textContent = labelText;
      const inp = document.createElement('input'); inp.type='text'; inp.name=name; inp.className='proof-input'; inp.placeholder=`Enter ${labelText.toLowerCase()}`;
      proofForm.append(lbl, inp);
    }
    function addFile(labelText, name){
      const lbl = document.createElement('label'); lbl.textContent = labelText+' (image)';
      const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*'; inp.name=name; inp.className='proof-input';
      proofForm.append(lbl, inp);
    }

    if (!clean.length) {
      addText('Proof','proof1');
    } else {
      clean.forEach((t,i)=>{
        const idx = i+1;
        if (t.toLowerCase()==='screenshot') addFile('Screenshot Proof', `proof${idx}`);
        else addText('Text Proof', `proof${idx}`);
      });
    }

    submitBtn.style.display = 'inline-block';
    modal.classList.add('show');

    // submit handler
    submitBtn.onclick = async (e)=>{
      e.preventDefault();
      submitStatus.textContent = '';
      submitBtn.disabled = true;
      try{
        const fields = [...proofForm.querySelectorAll('.proof-input')];
        const payload = {
          userId: currentUser.uid,
          userName: userNameEl.textContent,
          submittedAt: serverTimestamp(),   // server time
          status: 'pending'
        };

        for (let i=0;i<fields.length;i++){
          const f = fields[i];
          const key = `proof${i+1}`;
          if (f.type==='file'){
            if (!f.files?.[0]) throw new Error('Please attach all required screenshots.');
            const url = await uploadImageAndGetURL(f.files[0], `job_proofs/${job.id}/${currentUser.uid}`);
            payload[key] = url;
          } else {
            const v = f.value.trim();
            if (!v) throw new Error('Please fill in all proof fields.');
            payload[key] = v;
          }
        }

        await setDoc(subRef, payload);
        submitStatus.textContent = 'Submission successful!';
        submitStatus.style.color = 'green';
        submitBtn.style.display = 'none';
      } catch(err){
        submitStatus.textContent = 'Error: ' + err.message;
        submitStatus.style.color = 'red';
      } finally {
        submitBtn.disabled = false;
      }
    };
  }

  async function uploadImageAndGetURL(file, path){
    const ref_ = storageRef(storage, `${path}/${Date.now()}_${file.name}`);
    const snap = await uploadBytesResumable(ref_, file);
    return await getDownloadURL(snap.ref);
  }
</script>

</body>
</html>
