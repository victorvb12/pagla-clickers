<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pagla Clickers - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
  /* Modal overlay */
  .modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    overflow-y: auto;
    padding: 1rem;
  }
  .modal-overlay.show {
    display: flex;
  }
  .modal-content {
    background: white;
    max-width: 600px;
    width: 100%;
    border-radius: 6px;
    padding: 1.5rem;
    box-shadow: 0 0 10px rgba(0,0,0,0.25);
    position: relative;
  }
  .closeBtn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: transparent;
    border: none;
    font-size: 1.3rem;
    cursor: pointer;
  }

  label {
    display: block;
    margin-top: 1rem;
    font-weight: 600;
  }

  input.proof-input {
    width: 100%;
    padding: 0.3rem 0.5rem;
    margin-top: 0.3rem;
    box-sizing: border-box;
  }

  .submit-proof-btn {
    margin-top: 1.5rem;
    background-color: #007bff;
    border: none;
    color: white;
    padding: 0.6rem 1.2rem;
    font-size: 1rem;
    border-radius: 4px;
    cursor: pointer;
  }
  .submit-proof-btn:disabled {
    background-color: #999;
    cursor: default;
  }

  .submit-status {
    margin-top: 0.8rem;
    font-weight: 600;
  }

  .job-card {
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 1rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .job-card:hover, .job-card:focus {
    background-color: #e0f0ff;
    outline: none;
  }

  .job-info {
    font-size: 0.9rem;
    color: #555;
    margin-top: 0.3rem;
  }

  #jobDescriptionBox {
    background: #f5f5f5;
    padding: 1rem;
    border-radius: 6px;
    font-size: 1rem;
    line-height: 1.4;
    color: #333;
    margin-bottom: 1rem;
    max-height: 150px;
    overflow-y: auto;
    white-space: pre-wrap;
  }

  .proof-form label {
    font-weight: 600;
    margin-top: 1rem;
    display: block;
    color: #222;
  }

  .proof-input {
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 0.5rem;
    font-size: 1rem;
    width: 100%;
    box-sizing: border-box;
    margin-top: 0.3rem;
  }

  .submit-proof-btn {
    background-color: #2c7be5;
    border: none;
    color: white;
    padding: 0.7rem 1.4rem;
    border-radius: 5px;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  .submit-proof-btn:hover:not(:disabled) {
    background-color: #1a5fcc;
  }

  .submit-proof-btn:disabled {
    background-color: #999;
    cursor: not-allowed;
  }

  /* Desktop styles */
  @media (min-width: 601px) {
    #filterContainer {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 30px;
      margin-bottom: 20px;
      background: #f0f4ff;
      padding: 16px 20px;
      border-radius: 8px;
      border: 1px solid #a2b1d1;
    }

    #filterContainer > div {
      display: flex;
      flex-direction: column;
width: 180px;
      align-items: flex-start;
    }

    #filterContainer label {
      font-weight: 600;
      color: #334155;
      margin-bottom: 4px;
    }

    #filterContainer input[type="search"],
    #filterContainer select {
      padding: 8px 12px;
      border: 1px solid #aac0ff;
      border-radius: 6px;
      font-size: 1rem;
      background: white;
      color: #1e293b;
      min-width: 180px;
width: 100%;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    #filterContainer input[type="search"]:focus,
    #filterContainer select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 6px rgba(59, 130, 246, 0.5);
    }
  }

  /* Mobile styles */
  @media (max-width: 600px) {
    #filterContainer {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 12px;
      margin-bottom: 20px;
      background: #f0f4ff;
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid #a2b1d1;
    }

    #filterContainer > div {
      display: flex;
      flex-direction: column;
    }

    #filterContainer label {
      font-weight: 600;
      color: #334155;
      margin-bottom: 4px;
    }

    #filterContainer input[type="search"],
    #filterContainer select {
      padding: 8px 12px;
      border: 1px solid #aac0ff;
      border-radius: 6px;
      font-size: 1rem;
      background: white;
      color: #1e293b;
      width: 100%;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    #filterContainer input[type="search"]:focus,
    #filterContainer select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 6px rgba(59, 130, 246, 0.5);
    }
  }
</style>
</head>
<body>

  <header>
    Pagla Clickers Dashboard
    <button class="hamburger" aria-label="Toggle menu" onclick="toggleMenu()">☰</button>
  </header>

  <nav>
    <ul class="nav-links" id="navList">
      <li><a href="about.html">About</a></li>
      <li><a href="notifications.html">Notifications</a></li>
      <li><a href="profile.html">Profile</a></li>
      <li><a href="dashboard.html" aria-current="page">Dashboard</a></li>
      <li><a href="postjob.html">Post Job</a></li>
      <li><a href="jobs.html">My Jobs</a></li>
      <li><a href="referel.html">Referral</a></li>
      <li><a href="deposit.html">Deposit</a></li>
      <li><a href="wallet.html">Wallet</a></li>
      <li><a href="withdrawal.html">Withdraw Money</a></li>
      <li><a href="terms.html">Terms</a></li>
      <li><a href="faq.html">FAQ</a></li>
      <li><a href="support.html">Support</a></li>
      <li><button id="logoutBtn" class="logout-btn">Logout</button></li>
    </ul>
  </nav>

  <div class="blue-strip-below-nav"></div>

  <main class="container">

    <!-- Dashboard Section -->
    <section id="dashboardSection">
      <h2>Welcome, <span id="userName">Loading...</span></h2>
      <p>Your Balance: <strong id="userBalance">Loading...</strong></p>
    </section>

    <hr style="margin: 30px 0; border-color: #ccc;" />

    <!-- Task Detail Section -->
    <section id="taskDetailSection">
      <h2>Available Jobs</h2>
      <p id="jobCount" style="margin-bottom: 10px; font-weight: 600;">Loading jobs...</p>

      <div id="filterContainer" aria-label="Job filters">
  <div>
    <input type="search" id="searchInput" placeholder="Search jobs..." />
  </div>
  <div>
      <select id="categoryFilter">
      <option value="">All Categories</option>
    </select>
  </div>
  <div>
    <select id="sortSelect">
      <option value="default">Default</option>
      <option value="priceAsc">Price: Low to High</option>
      <option value="priceDesc">Price: High to Low</option>
    </select>
  </div>
</div>


      <section id="jobsContainer" class="jobs-list" aria-live="polite">Loading...</section>
    </section>
  </main>

  <!-- Modal -->
  <div id="jobModal" role="dialog" aria-modal="true" class="modal-overlay" aria-labelledby="jobTitle" aria-hidden="true">
    <div id="jobModalContent" class="modal-content">
      <button class="closeBtn" onclick="closeModal()" aria-label="Close modal">×</button>
      <h3 id="jobTitle"></h3>

      <div class="modal-job-info" id="modalJobInfo">
        <div><strong>Poster:</strong> <span id="modalPosterName">N/A</span></div>
        <div><strong>Job ID:</strong> <span id="modalJobId"></span></div>
        <div><strong>Category:</strong> <span id="modalJobCategory"></span></div>
        <div><strong>Completion:</strong> <span id="modalJobCompletion"></span></div>
      </div>

      <div>
        <div class="job-description-title" style="margin-top:1rem; font-weight:600;">Job Description</div>
        <div id="jobDescriptionBox" class="job-description-box" style="white-space: pre-wrap; margin-top:0.3rem;"></div>
      </div>

      <form id="proofForm" class="proof-form"></form>
      <button id="submitBtn" class="submit-proof-btn" style="display: none;">Submit Proof</button>
      <p id="submitStatus" class="submit-status"></p>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 Pagla Clickers. All rights reserved.</p>
  </footer>

  <script>
    function toggleMenu() {
      document.getElementById('navList').classList.toggle('active');
    }
    function closeModal() {
      const modal = document.getElementById('jobModal');
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden', 'true');
      currentJob = null;
      proofForm.innerHTML = "";
      submitStatus.textContent = "";
      submitBtn.style.display = "none";
    }
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAg-6k48R9c7ZK0xGe0BtNOa-5lF5JfmdI",
      authDomain: "pagla-b1c17.firebaseapp.com",
      projectId: "pagla-b1c17",
      storageBucket: "pagla-b1c17.appspot.com",
      messagingSenderId: "192578902502",
      appId: "1:192578902502:web:4b441210b15cfebf008ecf"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const userName = document.getElementById('userName');
    const userBalance = document.getElementById('userBalance');

    const jobsContainer = document.getElementById("jobsContainer");
    const jobModal = document.getElementById("jobModal");
    const jobTitle = document.getElementById("jobTitle");
    const jobDescriptionBox = document.getElementById("jobDescriptionBox");
    const proofForm = document.getElementById("proofForm");
    const submitBtn = document.getElementById("submitBtn");
    const submitStatus = document.getElementById("submitStatus");

    const modalPosterName = document.getElementById("modalPosterName");
    const modalJobId = document.getElementById("modalJobId");
    const modalJobCategory = document.getElementById("modalJobCategory");
    const modalJobCompletion = document.getElementById("modalJobCompletion");

    const logoutBtn = document.getElementById('logoutBtn');
    const searchInput = document.getElementById("searchInput");
    const categoryFilter = document.getElementById("categoryFilter");
    const sortSelect = document.getElementById("sortSelect");

    let currentUser = null;
    let currentJob = null;
    let jobList = [];
    let filteredList = [];

    logoutBtn.addEventListener('click', () => {
      signOut(auth).then(() => {
        window.location.href = "login.html";
      }).catch(error => {
        alert("Error signing out: " + error.message);
      });
    });

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (userDoc.exists()) {
          const data = userDoc.data();
          userName.innerText = data.username || "User";
          userBalance.innerText = "৳" + (data.balance ?? 0);
        } else {
          userName.innerText = "User";
          userBalance.innerText = "৳0";
        }
        await loadJobs();
      } else {
        window.location.href = "login.html";
      }
    });

    async function loadJobs() {
      try {
        const jobSnap = await getDocs(collection(db, "jobs"));
        jobList = [];

        await Promise.all(jobSnap.docs.map(async (docSnap) => {
          const data = docSnap.data();
          const jobId = docSnap.id;
          const subsSnap = await getDocs(collection(db, `jobs/${jobId}/submissions`));
          const submittedCount = subsSnap.size;
          jobList.push({ id: jobId, ...data, submitted: submittedCount });
        }));

        populateCategoryFilter();
        applyFilters();
      } catch (error) {
        jobsContainer.innerHTML = `<p style="padding:20px; color:red;">Failed to load jobs: ${error.message}</p>`;
      }
    }

    function populateCategoryFilter() {
      const categories = new Set();
      jobList.forEach(job => {
        if (job.category) categories.add(job.category);
      });
      categoryFilter.innerHTML = '<option value="">All Categories</option>';
      [...categories].sort().forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        categoryFilter.appendChild(option);
      });
    }

    function applyFilters() {
      const searchText = searchInput.value.trim().toLowerCase();
      const selectedCategory = categoryFilter.value;
      const sortOption = sortSelect.value;

      filteredList = jobList.filter(job => {
        const matchesSearch = job.title?.toLowerCase().includes(searchText);
        const matchesCategory = selectedCategory ? job.category === selectedCategory : true;
        return matchesSearch && matchesCategory;
      });

      if (sortOption === "priceAsc") {
        filteredList.sort((a, b) => (a.reward ?? 0) - (b.reward ?? 0));
      } else if (sortOption === "priceDesc") {
        filteredList.sort((a, b) => (b.reward ?? 0) - (a.reward ?? 0));
      }

      renderJobs();
    }

function renderJobs() {
  document.getElementById("jobCount").textContent = `Showing ${filteredList.length} job(s)`;
  jobsContainer.innerHTML = "";
  if (filteredList.length === 0) {
    jobsContainer.innerHTML = "<p>No jobs found matching criteria.</p>";
    return;
  }
  filteredList.forEach(job => {
    const submitted = job.submitted || 0;
    const slots = job.slots ?? "∞";
    const slotInfo = slots === "∞" ? "Unlimited slots" : `${submitted} / ${slots} used`;
    const isOwner = job.userId === currentUser?.uid;
    const crown = isOwner ? " 👑 Your Job" : "";

    const div = document.createElement("div");
    div.className = "job-card";
    div.tabIndex = 0;
    div.setAttribute('role', 'region');
    div.innerHTML = `
      <h3>${job.title || "Untitled Job"}${crown}</h3>
      <div class="job-info" style="display:flex; flex-direction: column; gap: 3px;">
        <div>Category: ${job.category || "Uncategorized"}</div>
        <div>Reward: ৳${job.reward ?? 0}</div>
        <div>Slots: ${slotInfo}</div>
      </div>
    `;

    div.addEventListener("click", () => openModal(job));
    div.addEventListener("keydown", (e) => { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); openModal(job); } });

    jobsContainer.appendChild(div);
  });
}


    searchInput.addEventListener("input", applyFilters);
    categoryFilter.addEventListener("change", applyFilters);
    sortSelect.addEventListener("change", applyFilters);

    // --- FIXED openModal function ---
async function openModal(job) {
  currentJob = job;
  jobTitle.textContent = job.title || "Untitled Job";
  modalPosterName.textContent = job.posterName || "N/A";
  modalJobId.textContent = job.id;
  modalJobCategory.textContent = job.category || "Uncategorized";

  const submitted = job.submitted || 0;
  const slots = job.slots === undefined ? Infinity : job.slots;
  const slotInfo = slots === Infinity ? "Unlimited slots" : `${submitted} / ${slots} used`;
  modalJobCompletion.textContent = slotInfo;

  jobDescriptionBox.textContent = job.description || "No description provided.";

  proofForm.innerHTML = "";
  submitStatus.textContent = "";
  submitBtn.style.display = "none";
  submitBtn.disabled = false;

  // Check if user already submitted for this job
  const submissionRef = doc(db, "jobs", job.id, "submissions", currentUser.uid);
  const submissionSnap = await getDoc(submissionRef);
  const hasSubmitted = submissionSnap.exists();

  if (currentUser.uid !== job.userId && !hasSubmitted) {
    // Collect all proof fields from job document
    const proofFields = [];
    if (job.proofType) proofFields.push(job.proofType);
    if (job.proof1) proofFields.push(job.proof1);
    if (job.proof2) proofFields.push(job.proof2);
    if (job.proof3) proofFields.push(job.proof3);

    // Filter out empty or 'None'
    const filteredProofFields = proofFields.filter(pt => pt && pt.trim() !== "" && pt.toLowerCase() !== "none");

    function createProofInput(type, index) {
      const label = document.createElement("label");
      label.textContent = `Proof (${type}):`;
      const input = document.createElement("input");
      input.type = "text";
      input.className = "proof-input";
      input.name = `proof${index + 1}`;
      input.placeholder = `Enter your proof (${type})`;
      proofForm.appendChild(label);
      proofForm.appendChild(input);
    }

    if (filteredProofFields.length > 0) {
      filteredProofFields.forEach((type, index) => {
        createProofInput(type, index);
      });
    } else {
      createProofInput("Proof", 0);
    }

    submitBtn.style.display = "inline-block";

  } else if (hasSubmitted) {
    // Show saved proofs from firestore fields proof1, proof2, proof3
    const data = submissionSnap.data();
    proofForm.innerHTML = "<strong>Your submission:</strong>";
    ['proof1', 'proof2', 'proof3'].forEach(key => {
      if (data[key]) {
        const div = document.createElement("div");
        div.style.marginTop = "6px";
        div.textContent = `${key}: ${data[key]}`;
        proofForm.appendChild(div);
      }
    });
  }

  jobModal.classList.add("show");
  jobModal.setAttribute("aria-hidden", "false");
}

submitBtn.addEventListener("click", async (e) => {
  e.preventDefault();
  submitStatus.textContent = "";
  submitBtn.disabled = true;

  const inputs = [...proofForm.querySelectorAll("input.proof-input")];
  const proofData = {};
  let allFilled = true;
  inputs.forEach(input => {
    if (!input.value.trim()) allFilled = false;
    proofData[input.name] = input.value.trim();
  });

  if (!allFilled) {
    submitStatus.textContent = "Please fill in all proof fields.";
    submitStatus.style.color = "red";
    submitBtn.disabled = false;
    return;
  }

  try {
    await setDoc(doc(db, "jobs", currentJob.id, "submissions", currentUser.uid), {
      ...proofData,
      userId: currentUser.uid,
      userName: userName.textContent,
      submittedAt: new Date().toISOString(),
    });
    submitStatus.textContent = "Submission successful!";
    submitStatus.style.color = "green";
    submitBtn.style.display = "none";
  } catch (error) {
    submitStatus.textContent = "Error submitting proof: " + error.message;
    submitStatus.style.color = "red";
  } finally {
    submitBtn.disabled = false;
  }
});

  </script>
</body>
</html>
