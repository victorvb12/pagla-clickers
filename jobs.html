<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Pagla Clickers - Jobs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Your existing CSS styles */
    .tabs {
      display: flex;
      border-bottom: 2px solid #7a5dc7;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      font-weight: 700;
      color: #7a5dc7;
      border: 2px solid transparent;
      border-bottom: none;
      user-select: none;
      outline: none;
    }
    .tab.active {
      background: #7a5dc7;
      color: #fff;
      border-radius: 8px 8px 0 0;
      border-color: #7a5dc7;
      border-bottom: 2px solid #fff;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .job-card {
      background: #fff;
      border-radius: 10px;
      padding: 15px 20px;
      margin-bottom: 15px;
      box-shadow: 0 0 10px rgba(138, 115, 202, .2);
      cursor: pointer;
      user-select: text;
      position: relative;
    }
    .job-card h3 {
      margin: 0 0 8px 0;
      color: #7a5dc7;
      font-weight: 700;
      font-size: 1.2rem;
    }
    .job-info {
      font-weight: 600;
      color: #444;
      font-size: 1rem;
      margin: 3px 0;
    }
    .job-actions {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .btn-submissions {
      background: #007bff;
      color: #fff;
      padding: 8px 14px;
      font-weight: 700;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    .btn-submissions:hover {
      background: #0056b3;
    }
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 3000;
      overflow-y: auto;
      padding: 20px;
    }
    .modal-overlay.open {
      display: flex;
    }
    .modal-content {
      background: #fff;
      border-radius: 12px;
      max-width: 600px;
      width: 100%;
      padding: 25px 30px;
      box-sizing: border-box;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }
    .closeBtn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #dc3545;
      border: none;
      color: #fff;
      font-weight: 700;
      font-size: 14px;
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color .3s ease;
    }
    .closeBtn:hover {
      background: #b02a37;
    }
    .submission-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #7a5dc7;
      border-radius: 8px;
      padding: 10px;
      background: #e9e9ff;
    }
    .submission-item {
      padding: 8px 10px;
      border-bottom: 1px solid #ccc;
      font-size: .95rem;
    }
    .submission-item:last-child {
      border-bottom: none;
    }
    .submission-item button {
      margin-top: 8px;
      padding: 6px 12px;
      font-weight: 700;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #28a745;
      color: #fff;
      transition: background-color .3s ease, opacity .2s ease;
    }
    .submission-item button:disabled {
      background: #6c757d;
      cursor: default;
      opacity: .85;
    }
  </style>
</head>

<body>
  <header>
    Pagla Clickers
    <button class="hamburger" id="menuBtn" type="button" aria-label="Toggle menu" aria-controls="navList"
      aria-expanded="false">☰</button>
  </header>
  <nav>
    <ul class="nav-links" id="navList">
      <li><a href="about.html">About</a></li>
      <li><a href="notifications.html">Notifications</a></li>
      <li><a href="profile.html">Profile</a></li>
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><a href="postjob.html">Post Job</a></li>
      <li><a href="jobs.html" aria-current="page">My Jobs</a></li>
      <li><a href="referral.html">Referral</a></li>
      <li><a href="deposit.html">Deposit</a></li>
      <li><a href="wallet.html">Wallet</a></li>
      <li><a href="withdrawal.html">Withdraw Money</a></li>
      <li><a href="terms.html">Terms</a></li>
      <li><a href="faq.html">FAQ</a></li>
      <li><a href="support.html">Support</a></li>
      <li style="display:flex; justify-content:center;">
        <button id="logoutBtn" type="button" class="logout-btn">Logout</button>
      </li>
    </ul>
  </nav>
  <div class="blue-strip-below-nav"></div>
  <div class="container">
    <div class="tabs" role="tablist" aria-label="Job categories">
      <div class="tab active" role="tab" tabindex="0" aria-selected="true" aria-controls="myJobsTab"
        id="myJobsTabBtn">My Jobs</div>
      <div class="tab" role="tab" tabindex="-1" aria-selected="false" aria-controls="completedJobsTab"
        id="completedJobsTabBtn">Completed Jobs</div>
    </div>
    <section id="myJobsTab" class="tab-content active" role="tabpanel" aria-labelledby="myJobsTabBtn">
      <p id="myJobsLoading">Loading your jobs...</p>
      <div id="myJobsList"></div>
    </section>
    <section id="completedJobsTab" class="tab-content" role="tabpanel" aria-labelledby="completedJobsTabBtn" hidden>
      <p>No completed jobs to show.</p>
      <div id="completedJobsList"></div>
    </section>
  </div>

  <!-- Submissions Modal -->
  <div id="submissionsModal" role="dialog" aria-modal="true" aria-labelledby="subsTitle" class="modal-overlay">
    <div class="modal-content" role="document">
      <button class="closeBtn" data-close aria-label="Close modal">Close</button>
      <h3 id="subsTitle">Job Submissions</h3>
      <div id="submissionList" class="submission-list"></div>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 Pagla Clickers. All rights reserved.</p>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import {
      getFirestore, collection, query, where, getDocs,
      doc, runTransaction, serverTimestamp, addDoc
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import { increment } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAg-6k48R9c7ZK0xGe0BtNOa-5lF5JfmdI",
      authDomain: "pagla-b1c17.firebaseapp.com",
      projectId: "pagla-b1c17",
      storageBucket: "pagla-b1c17.appspot.com",
      messagingSenderId: "192578902502",
      appId: "1:192578902502:web:1595070cdac289170f5e27"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await signOut(auth);
      window.location.href = 'login.html';
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = 'login.html';
      currentUser = user;
      await loadMyJobs();
    });

    async function loadMyJobs() {
      const myJobsList = document.getElementById('myJobsList');
      const myJobsLoading = document.getElementById('myJobsLoading');
      myJobsLoading.style.display = 'block';
      myJobsList.innerHTML = '';
      try {
        const jobsQuery = query(collection(db, 'jobs'), where('userId', '==', currentUser.uid));
        const snap = await getDocs(jobsQuery);
        if (snap.empty) {
          myJobsList.innerHTML = '<p>No jobs found.</p>';
        } else {
          const frag = document.createDocumentFragment();
          snap.forEach(docSnap => {
            const job = { id: docSnap.id, ...docSnap.data() };
            frag.appendChild(createJobCard(job));
          });
          myJobsList.appendChild(frag);
        }
      } catch (err) {
        myJobsList.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
      } finally {
        myJobsLoading.style.display = 'none';
      }
    }

    function createJobCard(job) {
      const div = document.createElement('div');
      div.className = 'job-card';
      div.innerHTML = `
        <h3>${job.title}</h3>
        <div class="job-info">Category: ${job.category}</div>
        <div class="job-info">Reward: ৳${Number(job.reward).toFixed(2)}</div>
        <div class="job-info">Slots: ${job.slots}</div>
        <div class="job-actions">
          <button class="btn-submissions">View Submissions</button>
        </div>
      `;
      div.querySelector('.btn-submissions').addEventListener('click', () => {
        loadSubmissions(job.id, job.userId, Number(job.reward));
      });
      return div;
    }

    async function loadSubmissions(jobId, jobOwnerId, reward) {
      const ml = document.getElementById('submissionList');
      document.getElementById('submissionsModal').classList.add('open');
      ml.innerHTML = '<p>Loading submissions...</p>';
      try {
        const subsSnap = await getDocs(collection(db, 'jobs', jobId, 'submissions'));
        ml.innerHTML = '';
        if (subsSnap.empty) {
          ml.innerHTML = '<p>No submissions.</p>';
        } else {
          subsSnap.forEach(docSnap => {
            const s = docSnap.data();
            const item = document.createElement('div');
            item.className = 'submission-item';
            item.innerHTML = `
              <p><strong>User:</strong> ${s.userName || 'Unknown'}</p>
              <p><strong>Status:</strong> ${s.status || 'Pending'}</p>
            `;
            if (currentUser.uid === jobOwnerId && s.status !== 'approved') {
              const btn = document.createElement('button');
              btn.textContent = 'Approve';
              btn.onclick = async () => {
                await approveSubmission(jobId, docSnap.id, s.userId || s.userUID, reward);
                await loadSubmissions(jobId, jobOwnerId, reward);
              };
              item.appendChild(btn);
            }
            ml.appendChild(item);
          });
        }
      } catch (err) {
        ml.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
      }
    }

    async function approveSubmission(jobId, submissionId, workerUserId, reward) {
      if (!workerUserId) return alert('Worker ID missing.');

      const submissionRef = doc(db, 'jobs', jobId, 'submissions', submissionId);
      const jobRef = doc(db, 'jobs', jobId);
      const walletRef = doc(db, 'wallets', workerUserId);
      const txCollection = collection(db, 'wallets', workerUserId, 'transactions');

      try {
        await runTransaction(db, async tx => {
          const submissionSnap = await tx.get(submissionRef);
          const jobSnap = await tx.get(jobRef);

          if (!submissionSnap.exists()) throw new Error('Submission not found.');
          if (!jobSnap.exists()) throw new Error('Job not found.');

          const s = submissionSnap.data();
          if (s.status === 'approved') throw new Error('Already approved.');

          tx.update(jobRef, { completed: (jobSnap.data().completed || 0) + 1 });
          tx.set(walletRef, { balance: increment(reward) }, { merge: true });
          tx.update(submissionRef, { status: 'approved', approvedAt: serverTimestamp() });
        });

        await addDoc(txCollection, {
          type: 'job_earn',
          amount: Number(reward),
          status: 'approved',
          date: serverTimestamp(),
          jobId,
          submissionId
        });

        alert('Approved & credited!');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    // Tab and modal logic omitted for brevity (same as your existing version)
  </script>
</body>
</html>
